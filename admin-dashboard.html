<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Toolspay — Admin Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .container { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: grid; gap: 12px; }
    @media (min-width: 700px) { .row-2 { grid-template-columns: 1fr 1fr; } .row-3 { grid-template-columns: 1fr 1fr 1fr; } }
    label { font-weight: 600; font-size: 14px; margin-bottom: 6px; display: block; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; }
    .btn-primary { background: black; color: gold; border: 2px solid gold; }
    .btn-ghost { background: #f4f4f4; }
    .tag { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .muted { color: #6b7280; font-size: 12px; }
    .danger { color: #b91c1c; }
    .ok { color: #059669; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .hidden { display:none; }
    .list { border:1px dashed #ddd; border-radius: 10px; padding: 10px; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 12px; }
    .tab { padding:8px 12px; border-radius:999px; border:1px solid #eee; cursor:pointer; }
    .tab.active { background:#0b1220; color:#fff; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid #eee; padding:8px; text-align:left; }
  </style>
</head>

<body>
  <header style="padding:16px; border-bottom:1px solid #eee; background:#0b1220;">
    <div class="container header" style="color:#fff;">
      <div class="flex">
        <div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#111,#ffd700);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;">TP</div>
        <div>
          <div style="font-weight:800;">Toolspay — Admin</div>
          <div class="muted" style="color:#cbd5e1;">Manage rates, wallets, announcements</div>
        </div>
      </div>
      <div>
        <button id="logoutBtn" class="btn-ghost">Sign out</button>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- AUTH GATE -->
    <div id="authBlock" class="card">
      <h2>Admin sign in</h2>
      <p class="muted">Only approved emails can access.</p>
      <div class="row row-2" style="margin-top:10px;">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com"/>
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••"/>
        </div>
      </div>
      <div class="flex" style="margin-top:10px;">
        <button id="loginBtn" class="btn-primary">Sign in</button>
        <button id="resetBtn" class="btn-ghost">Send reset link</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- NOT AUTHORIZED -->
    <div id="notAdmin" class="card hidden">
      <h3 class="danger">Not authorized</h3>
      <p class="muted">
        This account is not in <code>admins</code>. Click below to add your current email.
      </p>
      <button id="grantBtn" class="btn-primary">Grant admin to my email</button>
      <div id="grantMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ADMIN PANEL -->
    <section id="adminPanel" class="hidden">

      <div class="card">
        <div class="header">
          <h2>General</h2>
          <span class="muted">rates/default, wallets/default, announcements/default</span>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="ratesTab">Rates</div>
          <div class="tab" data-tab="walletsTab">Crypto Wallets</div>
          <div class="tab" data-tab="annTab">Announcements</div>
          <div class="tab" data-tab="giftTab">Gift Card Rates</div>
          <div class="tab" data-tab="owTab">Online Wallet Rates</div>
        </div>

        <!-- RATES TAB -->
        <div id="ratesTab">
          <div class="row row-2" style="margin-top:10px;">
            <div>
              <label>USD → NGN</label>
              <input id="usdToNgn" type="number" placeholder="1500"/>
              <div class="muted">Shown to customers.</div>
            </div>
            <div>
              <label>Default Gift Card base (₦ / $1)</label>
              <input id="giftcardBase" type="number" placeholder="1450"/>
              <div class="muted">Each brand/country can override below.</div>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="saveRates" class="btn-primary">Save rates</button>
            <span id="ratesMsg" class="muted"></span>
          </div>
        </div>

        <!-- WALLETS TAB -->
        <div id="walletsTab" class="hidden">
          <div class="row row-2" style="margin-top:10px;">
            <div>
              <label>BTC Address</label>
              <input id="btcAddress" placeholder="bc1..."/>
            </div>
            <div>
              <label>Online wallet quick tags (optional)</label>
              <div class="row">
                <input id="tagChime" placeholder="Chime tag (optional)"/>
                <input id="tagZelle" placeholder="Zelle tag/email (optional)"/>
                <input id="tagVenmo" placeholder="@venmo (optional)"/>
                <input id="tagPaypal" placeholder="PayPal email (optional)"/>
              </div>
              <div class="muted">For your own reference when chatting.</div>
            </div>
          </div>

          <div class="card" style="background:#fafafa;">
            <h3>USDT Networks</h3>
            <div id="networksList" class="list" style="margin-top:8px;"></div>
            <div class="row row-3" style="margin-top:8px;">
              <div><input id="newNetName" placeholder="TRC20 / ERC20 / BEP20"/></div>
              <div><input id="newNetAddr" placeholder="USDT address for this network"/></div>
              <div><button id="addNetwork" class="btn-ghost">Add network</button></div>
            </div>
          </div>

          <div style="margin-top:10px;">
            <button id="saveWallets" class="btn-primary">Save wallets</button>
            <span id="walletsMsg" class="muted"></span>
          </div>
        </div>

        <!-- ANNOUNCEMENTS TAB -->
        <div id="annTab" class="hidden">
          <div style="margin-top:10px;">
            <label>One per line</label>
            <textarea id="annTextarea" rows="5" placeholder="Welcome to Toolspay&#10;Trade only inside this site"></textarea>
          </div>
          <div style="margin-top:10px;">
            <button id="saveAnn" class="btn-primary">Save announcements</button>
            <span id="annMsg" class="muted"></span>
          </div>
        </div>

        <!-- GIFT CARD RATES TAB -->
        <div id="giftTab" class="hidden">
          <div class="row row-3">
            <div>
              <label>Card</label>
              <input id="gcCard" placeholder="Apple, Amazon, Steam, Google, Visa, Razer Gold, Walmart, Amex"/>
            </div>
            <div>
              <label>Country</label>
              <input id="gcCountry" placeholder="USA, UK, EU, CA, AU, CH, etc."/>
            </div>
            <div>
              <label>Rate (₦ / $1)</label>
              <input id="gcRate" type="number" placeholder="e.g. 1450"/>
            </div>
          </div>
          <div class="row row-2" style="margin-top:8px;">
            <div>
              <label>Status</label>
              <select id="gcEnabled">
                <option value="true" selected>Enabled</option>
                <option value="false">Disabled</option>
              </select>
            </div>
            <div style="display:flex; align-items:end;">
              <button id="addGc" class="btn-primary">Add / Update</button>
            </div>
          </div>
          <div id="gcMsg" class="muted" style="margin-top:8px;"></div>

          <div class="card" style="margin-top:12px;">
            <h3>Gift Card Catalog</h3>
            <table class="table" id="gcTable">
              <thead>
                <tr><th>Card</th><th>Country</th><th>Rate</th><th>Status</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="muted">Collection: <code>giftcardCatalog</code> (doc id = <code>{card}__{country}</code>)</div>
          </div>
        </div>

        <!-- ONLINE WALLET RATES TAB -->
        <div id="owTab" class="hidden">
          <div class="row row-3">
            <div>
              <label>Wallet</label>
              <input id="owWallet" placeholder="PayPal, Chime, Zelle, Venmo"/>
            </div>
            <div>
              <label>Country</label>
              <input id="owCountry" placeholder="USA, UK, EU, CA, etc."/>
            </div>
            <div>
              <label>Rate (₦ / $1)</label>
              <input id="owRate" type="number" placeholder="e.g. 1200"/>
            </div>
          </div>
          <div class="row row-2" style="margin-top:8px;">
            <div>
              <label>Status</label>
              <select id="owEnabled">
                <option value="true" selected>Enabled</option>
                <option value="false">Disabled</option>
              </select>
            </div>
            <div style="display:flex; align-items:end;">
              <button id="addOw" class="btn-primary">Add / Update</button>
            </div>
          </div>
          <div id="owMsg" class="muted" style="margin-top:8px;"></div>

          <div class="card" style="margin-top:12px;">
            <h3>Online Wallet Catalog</h3>
            <table class="table" id="owTable">
              <thead>
                <tr><th>Wallet</th><th>Country</th><th>Rate</th><th>Status</th><th></th></tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="muted">Collection: <code>walletRates</code> (doc id = <code>{wallet}__{country}</code>)</div>
          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- Admin script -->
  <script type="module">
    import {
      auth, db,
      signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged,
      doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs
    } from './firebase-auth.js';

    // Simple tabs
    const tabs = document.querySelectorAll('.tab');
    const sections = {
      ratesTab: document.getElementById('ratesTab'),
      walletsTab: document.getElementById('walletsTab'),
      annTab: document.getElementById('annTab'),
      giftTab: document.getElementById('giftTab'),
      owTab: document.getElementById('owTab'),
    };
    tabs.forEach(t=>{
      t.onclick=()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        Object.values(sections).forEach(s=>s.classList.add('hidden'));
        sections[t.dataset.tab].classList.remove('hidden');
      }
    });

    // UI refs
    const authBlock  = document.getElementById('authBlock');
    const adminPanel = document.getElementById('adminPanel');
    const notAdmin   = document.getElementById('notAdmin');

    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const resetBtn = document.getElementById('resetBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMsg = document.getElementById('authMsg');
    const grantBtn = document.getElementById('grantBtn');
    const grantMsg = document.getElementById('grantMsg');

    // General rates
    const usdToNgn = document.getElementById('usdToNgn');
    const giftcardBase = document.getElementById('giftcardBase');
    const saveRates = document.getElementById('saveRates');
    const ratesMsg = document.getElementById('ratesMsg');

    // Wallets
    const btcAddress = document.getElementById('btcAddress');
    const tagChime = document.getElementById('tagChime');
    const tagZelle = document.getElementById('tagZelle');
    const tagVenmo = document.getElementById('tagVenmo');
    const tagPaypal = document.getElementById('tagPaypal');
    const networksList = document.getElementById('networksList');
    const newNetName = document.getElementById('newNetName');
    const newNetAddr = document.getElementById('newNetAddr');
    const addNetwork = document.getElementById('addNetwork');
    const saveWallets = document.getElementById('saveWallets');
    const walletsMsg = document.getElementById('walletsMsg');
    let usdtNetworks = [];

    // Announcements
    const annTextarea = document.getElementById('annTextarea');
    const saveAnn = document.getElementById('saveAnn');
    const annMsg = document.getElementById('annMsg');

    // Gift card catalog
    const gcCard = document.getElementById('gcCard');
    const gcCountry = document.getElementById('gcCountry');
    const gcRate = document.getElementById('gcRate');
    const gcEnabled = document.getElementById('gcEnabled');
    const addGc = document.getElementById('addGc');
    const gcMsg = document.getElementById('gcMsg');
    const gcTableBody = document.querySelector('#gcTable tbody');

    // Online wallet catalog
    const owWallet = document.getElementById('owWallet');
    const owCountry = document.getElementById('owCountry');
    const owRate = document.getElementById('owRate');
    const owEnabled = document.getElementById('owEnabled');
    const addOw = document.getElementById('addOw');
    const owMsg = document.getElementById('owMsg');
    const owTableBody = document.querySelector('#owTable tbody');

    // Helpers
    const idKey = (a,b)=>`${(a||'').trim().toUpperCase()}__${(b||'').trim().toUpperCase()}`;

    function renderNetworks() {
      networksList.innerHTML = '';
      if (!usdtNetworks.length) {
        networksList.innerHTML = '<div class="muted">No USDT networks yet.</div>';
        return;
      }
      usdtNetworks.forEach((n, idx) => {
        const row = document.createElement('div');
        row.className = 'flex'; row.style.justifyContent='space-between'; row.style.padding='6px 0';
        row.innerHTML = `
          <div class="flex"><span class="tag">${n.network}</span>
          <span class="muted" style="margin-left:6px;">${n.address}</span></div>
          <button data-idx="${idx}" class="btn-ghost">Remove</button>`;
        row.querySelector('button').onclick = e=>{
          const i = Number(e.currentTarget.getAttribute('data-idx'));
          usdtNetworks.splice(i,1); renderNetworks();
        };
        networksList.appendChild(row);
      });
    }
    addNetwork.onclick = ()=>{
      const net=(newNetName.value||'').trim(); const addr=(newNetAddr.value||'').trim();
      if(!net||!addr) return; usdtNetworks.push({network:net,address:addr});
      newNetName.value=''; newNetAddr.value=''; renderNetworks();
    };

    // Auth
    loginBtn.onclick = async () => {
      authMsg.textContent = 'Signing in...';
      try {
        await signInWithEmailAndPassword(emailEl.value.trim(), passEl.value);
        authMsg.textContent = '';
      } catch (e) {
        authMsg.textContent = 'Sign in failed: ' + (e.message || e.code);
      }
    };
    resetBtn.onclick = async () => {
      const em = (emailEl.value||'').trim(); if(!em){authMsg.textContent='Enter email first.';return;}
      try { await sendPasswordResetEmail(em); authMsg.textContent = 'Reset link sent to '+em; }
      catch(e){ authMsg.textContent='Reset failed: '+(e.message||e.code); }
    };
    logoutBtn.onclick = async () => { await auth.signOut(); location.reload(); };

    if (document.getElementById('grantBtn')) {
      grantBtn.onclick = async () => {
        if (!auth.currentUser?.email) { grantMsg.textContent='Sign in first.'; return; }
        try {
          await setDoc(doc(db,'admins', auth.currentUser.email), { createdAt: Date.now() });
          grantMsg.textContent='This email is now an admin. Reloading...';
          setTimeout(()=>location.reload(), 800);
        } catch(e){ grantMsg.textContent='Failed: '+(e.message||e.code); }
      };
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) { authBlock.classList.remove('hidden'); adminPanel.classList.add('hidden'); notAdmin.classList.add('hidden'); return; }
      const a = await getDoc(doc(db, 'admins', user.email));
      if (!a.exists()) { authBlock.classList.add('hidden'); notAdmin.classList.remove('hidden'); adminPanel.classList.add('hidden'); return; }
      authBlock.classList.add('hidden'); notAdmin.classList.add('hidden'); adminPanel.classList.remove('hidden');

      await loadRates(); await loadWallets(); await loadAnnouncements();
      await listGiftcards(); await listWalletRates();
    });

    // Load/Saves — General rates
    async function loadRates(){
      const r = await getDoc(doc(db,'rates','default'));
      if(r.exists()){ const d=r.data(); usdToNgn.value=d.usdToNgn??''; giftcardBase.value=d.giftcardBase??''; }
    }
    saveRates.onclick = async ()=>{
      ratesMsg.textContent='Saving...';
      try{
        await setDoc(doc(db,'rates','default'),{
          usdToNgn: Number(usdToNgn.value||0),
          giftcardBase: Number(giftcardBase.value||0)
        },{merge:true});
        ratesMsg.textContent='Saved ✓'; setTimeout(()=>ratesMsg.textContent='',1200);
      }catch(e){ ratesMsg.textContent='Error: '+(e.message||e.code); }
    };

    // Load/Saves — Wallets
    async function loadWallets(){
      const w=await getDoc(doc(db,'wallets','default'));
      if(w.exists()){
        const d=w.data();
        btcAddress.value=d?.btc?.address||'';
        const tags=d?.tags||{};
        tagChime.value=tags.chime||''; tagZelle.value=tags.zelle||''; tagVenmo.value=tags.venmo||''; tagPaypal.value=tags.paypal||'';
        usdtNetworks=(d?.usdt?.networks||[]).slice(); renderNetworks();
      } else { usdtNetworks=[]; renderNetworks(); }
    }
    saveWallets.onclick = async ()=>{
      walletsMsg.textContent='Saving...';
      try{
        await setDoc(doc(db,'wallets','default'),{
          btc:{ address:(btcAddress.value||'').trim() },
          usdt:{ networks: usdtNetworks },
          tags:{
            chime:(tagChime.value||'').trim(),
            zelle:(tagZelle.value||'').trim(),
            venmo:(tagVenmo.value||'').trim(),
            paypal:(tagPaypal.value||'').trim()
          }
        },{merge:true});
        walletsMsg.textContent='Saved ✓'; setTimeout(()=>walletsMsg.textContent='',1200);
      }catch(e){ walletsMsg.textContent='Error: '+(e.message||e.code); }
    };

    // Load/Saves — Announcements
    async function loadAnnouncements(){
      const a=await getDoc(doc(db,'announcements','default'));
      if(a.exists()){ const d=a.data(); const arr=Array.isArray(d.items)?d.items:[]; annTextarea.value=arr.join('\n'); }
    }
    saveAnn.onclick = async ()=>{
      annMsg.textContent='Saving...';
      try{
        const items=(annTextarea.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
        await setDoc(doc(db,'announcements','default'),{items},{merge:true});
        annMsg.textContent='Saved ✓'; setTimeout(()=>annMsg.textContent='',1200);
      }catch(e){ annMsg.textContent='Error: '+(e.message||e.code); }
    };

    // Gift Card Catalog CRUD (giftcardCatalog)
    async function listGiftcards(){
      gcTableBody.innerHTML = '';
      const snap = await getDocs(collection(db,'giftcardCatalog'));
      const rows = [];
      snap.forEach(d=>{
        const v=d.data();
        rows.push(`<tr>
          <td>${v.card||''}</td>
          <td>${v.country||''}</td>
          <td>₦ ${v.rate||0} / $1</td>
          <td>${v.enabled?'<span class="ok">Enabled</span>':'<span class="muted">Disabled</span>'}</td>
          <td><button class="btn-ghost" data-id="${d.id}">Delete</button></td>
        </tr>`);
      });
      gcTableBody.innerHTML = rows.join('') || `<tr><td colspan="5" class="muted">No entries yet.</td></tr>`;
      gcTableBody.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          await deleteDoc(doc(db,'giftcardCatalog', btn.dataset.id));
          await listGiftcards();
        }
      });
    }
    addGc.onclick = async ()=>{
      const card=(gcCard.value||'').trim();
      const country=(gcCountry.value||'').trim();
      const rate=Number(gcRate.value||0);
      const enabled=(gcEnabled.value==='true');
      if(!card||!country){ gcMsg.textContent='Enter card and country'; return; }
      gcMsg.textContent='Saving...';
      try{
        await setDoc(doc(db,'giftcardCatalog', idKey(card,country)),{card,country,rate,enabled},{merge:true});
        gcMsg.textContent='Saved ✓'; setTimeout(()=>gcMsg.textContent='',1200);
        gcCard.value=''; gcCountry.value=''; gcRate.value='';
        await listGiftcards();
      }catch(e){ gcMsg.textContent='Error: '+(e.message||e.code); }
    };

    // Online Wallet Rates CRUD (walletRates)
    async function listWalletRates(){
      owTableBody.innerHTML = '';
      const snap = await getDocs(collection(db,'walletRates'));
      const rows=[];
      snap.forEach(d=>{
        const v=d.data();
        rows.push(`<tr>
          <td>${v.wallet||''}</td>
          <td>${v.country||''}</td>
          <td>₦ ${v.rate||0} / $1</td>
          <td>${v.enabled?'<span class="ok">Enabled</span>':'<span class="muted">Disabled</span>'}</td>
          <td><button class="btn-ghost" data-id="${d.id}">Delete</button></td>
        </tr>`);
      });
      owTableBody.innerHTML = rows.join('') || `<tr><td colspan="5" class="muted">No entries yet.</td></tr>`;
      owTableBody.querySelectorAll('button[data-id]').forEach(btn=>{
        btn.onclick = async ()=>{
          await deleteDoc(doc(db,'walletRates', btn.dataset.id));
          await listWalletRates();
        }
      });
    }
    addOw.onclick = async ()=>{
      const wallet=(owWallet.value||'').trim();
      const country=(owCountry.value||'').trim();
      const rate=Number(owRate.value||0);
      const enabled=(owEnabled.value==='true');
      if(!wallet||!country){ owMsg.textContent='Enter wallet and country'; return; }
      owMsg.textContent='Saving...';
      try{
        await setDoc(doc(db,'walletRates', idKey(wallet,country)),{wallet,country,rate,enabled},{merge:true});
        owMsg.textContent='Saved ✓'; setTimeout(()=>owMsg.textContent='',1200);
        owWallet.value=''; owCountry.value=''; owRate.value='';
        await listWalletRates();
      }catch(e){ owMsg.textContent='Error: '+(e.message||e.code); }
    };

  </script>
</body>
  </html>
