<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Toolspay — Admin Dashboard</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* Minimal clean styling */
    :root { --bg:#0b1220; --gold:#ffd700; }
    body{background:#f7f7fb;}
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; margin:14px 0; }
    .row { display:grid; gap:12px; }
    @media (min-width: 780px){ .row-2{ grid-template-columns:1fr 1fr } .row-3{ grid-template-columns:1fr 1fr 1fr } }
    label { font-weight: 600; font-size: 14px; margin-bottom: 6px; display:block; }
    input, select, textarea { width:100%; padding:10px; border:1px solid #dcdcdc; border-radius:10px; font-size:14px; }
    textarea{ resize:vertical; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:600; }
    .btn-primary { background:#000; color:var(--gold); border:2px solid var(--gold); }
    .btn-ghost { background:#f1f1f4; }
    .btn-danger{ background:#b91c1c; color:#fff; }
    .muted{ color:#6b7280; font-size:12px; }
    .tag{ padding:6px 10px; border:1px solid #ddd; border-radius:999px; font-size:12px; background:#fafafa; }
    .flex{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .hidden{ display:none; }
    .list{ border:1px dashed #ddd; border-radius:10px; padding:10px; }
    .section-title{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .brand-row{ border:1px solid #eee; border-radius:10px; padding:10px; margin:10px 0; background:#fafafa; }
    .country-row{ display:grid; grid-template-columns: 130px 1fr 90px; gap:8px; align-items:center; margin:6px 0; }
    @media (max-width:560px){ .country-row{ grid-template-columns: 1fr 1fr; } .country-row .remove{ grid-column: 1 / -1; } }
  </style>
</head>

<body>
  <header style="padding:16px; border-bottom:1px solid #eee; background:var(--bg);">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; color:#fff;">
      <div class="flex">
        <div style="width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,#111,var(--gold));display:flex;align-items:center;justify-content:center;font-weight:800;">TP</div>
        <div>
          <div style="font-weight:800;">Toolspay — Admin</div>
          <div class="muted" style="color:#cbd5e1;">Manage rates, wallets, gift cards & announcements</div>
        </div>
      </div>
      <button id="logoutBtn" class="btn-ghost">Sign out</button>
    </div>
  </header>

  <main class="container">

    <!-- AUTH GATE -->
    <div id="authBlock" class="card">
      <h2>Admin sign in</h2>
      <p class="muted">Only emails in <code>admins</code> can access.</p>
      <div class="row row-2" style="margin-top:10px;">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com"/>
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="••••••••"/>
        </div>
      </div>
      <div class="flex" style="margin-top:10px;">
        <button id="loginBtn" class="btn-primary">Sign in</button>
        <button id="resetBtn" class="btn-ghost">Send reset link</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- NOT AUTHORIZED -->
    <div id="notAdmin" class="card hidden">
      <h3 style="color:#b91c1c;">Not authorized</h3>
      <p class="muted">Click below to add your signed-in email to <code>admins</code> (one-time setup).</p>
      <button id="grantBtn" class="btn-primary">Grant admin to my email</button>
      <div id="grantMsg" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ADMIN PANEL -->
    <section id="adminPanel" class="hidden">

      <!-- Global rates -->
      <div class="card">
        <div class="section-title">
          <h2>Global Rates</h2>
          <span class="muted">Doc: <code>rates/default</code></span>
        </div>
        <div class="row row-2" style="margin-top:10px;">
          <div>
            <label>USD → NGN</label>
            <input id="usdToNgn" type="number" placeholder="1500"/>
            <div class="muted">Displayed to users and used as default conversion.</div>
          </div>
          <div>
            <label>Default gift card base (₦ per $1)</label>
            <input id="giftcardBase" type="number" placeholder="1450"/>
            <div class="muted">Brand/country can override below.</div>
          </div>
        </div>
        <div style="margin-top:10px;">
          <button id="saveRates" class="btn-primary">Save global rates</button>
          <span id="ratesMsg" class="muted"></span>
        </div>
      </div>

      <!-- Gift cards manager -->
      <div class="card">
        <div class="section-title">
          <h2>Gift Cards (per-brand, per-country rates)</h2>
          <span class="muted">Collection: <code>giftcards</code> (one doc per brand)</span>
        </div>

        <div id="brandsWrap"></div>

        <div class="row row-3" style="margin-top:10px;">
          <div><input id="newBrandId" placeholder="brand id (e.g. apple, amazon)"/></div>
          <div><input id="newBrandName" placeholder="Display name (e.g. Apple / iTunes)"/></div>
          <div><button id="addBrandBtn" class="btn-ghost">Add new brand</button></div>
        </div>

        <div style="margin-top:10px;">
          <button id="saveAllBrands" class="btn-primary">Save all gift cards</button>
          <span id="brandsMsg" class="muted"></span>
        </div>

        <div class="muted" style="margin-top:8px;">
          Tip: Users will see each brand with the country dropdown and the **rate in front**.  
          When they enter face value, their payout (₦) is calculated instantly from your rate.
        </div>
      </div>

      <!-- Online wallet rates -->
      <div class="card">
        <div class="section-title">
          <h2>Online Wallets (rates & enable/disable)</h2>
          <span class="muted">Doc: <code>wallets/default</code></span>
        </div>

        <div class="row row-2">
          <div class="brand-row">
            <div class="flex" style="justify-content:space-between;">
              <strong>Chime</strong>
              <label class="flex"><input type="checkbox" id="chimeEnable"/> Enable</label>
            </div>
            <div class="row row-2" style="margin-top:8px;">
              <div>
                <label>Rate (₦ per $1)</label>
                <input id="chimeRate" type="number" placeholder="e.g. 1400"/>
              </div>
              <div>
                <label>Tag / Note (optional)</label>
                <input id="chimeTag" placeholder="Your Chime tag"/>
              </div>
            </div>
          </div>

          <div class="brand-row">
            <div class="flex" style="justify-content:space-between;">
              <strong>Zelle</strong>
              <label class="flex"><input type="checkbox" id="zelleEnable"/> Enable</label>
            </div>
            <div class="row row-2" style="margin-top:8px;">
              <div>
                <label>Rate (₦ per $1)</label>
                <input id="zelleRate" type="number" placeholder="e.g. 1380"/>
              </div>
              <div>
                <label>Tag / Email (optional)</label>
                <input id="zelleTag" placeholder="Zelle email/phone"/>
              </div>
            </div>
          </div>

          <div class="brand-row">
            <div class="flex" style="justify-content:space-between;">
              <strong>Venmo</strong>
              <label class="flex"><input type="checkbox" id="venmoEnable"/> Enable</label>
            </div>
            <div class="row row-2" style="margin-top:8px;">
              <div>
                <label>Rate (₦ per $1)</label>
                <input id="venmoRate" type="number" placeholder="e.g. 1360"/>
              </div>
              <div>
                <label>@Tag (optional)</label>
                <input id="venmoTag" placeholder="@venmo"/>
              </div>
            </div>
          </div>

          <div class="brand-row">
            <div class="flex" style="justify-content:space-between;">
              <strong>PayPal</strong>
              <label class="flex"><input type="checkbox" id="paypalEnable"/> Enable</label>
            </div>
            <div class="row row-2" style="margin-top:8px;">
              <div>
                <label>Rate (₦ per $1)</label>
                <input id="paypalRate" type="number" placeholder="e.g. 1300"/>
              </div>
              <div>
                <label>Email (optional)</label>
                <input id="paypalTag" placeholder="PayPal email"/>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button id="saveWalletRates" class="btn-primary">Save wallet rates</button>
          <span id="walletRatesMsg" class="muted"></span>
        </div>

        <div class="muted" style="margin-top:8px;">
          Customers won’t upload for online wallets; they will click the wallet, see the rate in front, then **open live chat** to request your tag. You paste your tag there.
        </div>
      </div>

      <!-- Crypto wallets -->
      <div class="card">
        <div class="section-title">
          <h2>Crypto Wallets</h2>
          <span class="muted">Doc: <code>wallets/default</code></span>
        </div>
        <div class="row row-2" style="margin-top:10px;">
          <div>
            <label>BTC Address</label>
            <input id="btcAddress" placeholder="bc1... / 1..."/>
          </div>
          <div>
            <label>USD→NGN (for crypto display)</label>
            <input id="displayUsdToNgn" type="number" placeholder="(uses global if empty)"/>
          </div>
        </div>

        <div class="card" style="background:#fafafa;">
          <h3>USDT Networks</h3>
          <div id="networksList" class="list" style="margin-top:8px;"></div>
          <div class="row row-3" style="margin-top:8px;">
            <div><input id="newNetName" placeholder="TRC20 / ERC20 / BEP20"/></div>
            <div><input id="newNetAddr" placeholder="USDT address for this network"/></div>
            <div><button id="addNetwork" class="btn-ghost">Add network</button></div>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button id="saveWallets" class="btn-primary">Save crypto wallets</button>
          <span id="walletsMsg" class="muted"></span>
        </div>
      </div>

      <!-- Announcements -->
      <div class="card">
        <div class="section-title">
          <h2>Announcements</h2>
          <span class="muted">Doc: <code>announcements/default</code></span>
        </div>
        <div style="margin-top:10px;">
          <label>One per line</label>
          <textarea id="annTextarea" rows="5" placeholder="Welcome to Toolspay&#10;Trade safely via this site only"></textarea>
        </div>
        <div style="margin-top:10px;">
          <button id="saveAnn" class="btn-primary">Save announcements</button>
          <span id="annMsg" class="muted"></span>
        </div>
      </div>

      <!-- Proof uploads -->
      <div class="card">
        <div class="section-title">
          <h2>Proof Uploads (admin only)</h2>
          <span class="muted">Collection: <code>proofs</code> + Storage: <code>proofs/</code></span>
        </div>
        <div class="row row-2">
          <div>
            <label>Screenshot image</label>
            <input id="proofFile" type="file" accept="image/*"/>
          </div>
          <div>
            <label>Note (optional)</label>
            <input id="proofNote" placeholder="e.g., Card already used — evidence"/>
          </div>
        </div>
        <div style="margin-top:10px;">
          <button id="uploadProofBtn" class="btn-ghost">Upload proof</button>
          <span id="proofMsg" class="muted"></span>
        </div>
      </div>

    </section>
  </main>

  <!-- Admin logic -->
  <script type="module">
    import {
      auth, db, storage,
      // auth
      signInWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged,
      // firestore helpers from our module
      doc, getDoc, setDoc, getDocs, collection, updateDoc, addDoc, serverTimestamp
    } from './firebase-auth.js';
    // storage
    import { ref as storageRef, uploadBytes, getDownloadURL }
      from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // UI refs
    const authBlock  = document.getElementById('authBlock');
    const adminPanel = document.getElementById('adminPanel');
    const notAdmin   = document.getElementById('notAdmin');

    const emailEl = document.getElementById('email');
    const passEl  = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const resetBtn = document.getElementById('resetBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authMsg = document.getElementById('authMsg');

    const grantBtn = document.getElementById('grantBtn');
    const grantMsg = document.getElementById('grantMsg');

    // Global rates
    const usdToNgn = document.getElementById('usdToNgn');
    const giftcardBase = document.getElementById('giftcardBase');
    const saveRates = document.getElementById('saveRates');
    const ratesMsg = document.getElementById('ratesMsg');

    // Gift cards
    const brandsWrap = document.getElementById('brandsWrap');
    const newBrandId = document.getElementById('newBrandId');
    const newBrandName = document.getElementById('newBrandName');
    const addBrandBtn = document.getElementById('addBrandBtn');
    const saveAllBrands = document.getElementById('saveAllBrands');
    const brandsMsg = document.getElementById('brandsMsg');

    // Online wallet rates
    const chimeEnable = document.getElementById('chimeEnable');
    const chimeRate   = document.getElementById('chimeRate');
    const chimeTag    = document.getElementById('chimeTag');

    const zelleEnable = document.getElementById('zelleEnable');
    const zelleRate   = document.getElementById('zelleRate');
    const zelleTag    = document.getElementById('zelleTag');

    const venmoEnable = document.getElementById('venmoEnable');
    const venmoRate   = document.getElementById('venmoRate');
    const venmoTag    = document.getElementById('venmoTag');

    const paypalEnable = document.getElementById('paypalEnable');
    const paypalRate   = document.getElementById('paypalRate');
    const paypalTag    = document.getElementById('paypalTag');

    const walletRatesMsg = document.getElementById('walletRatesMsg');

    // Crypto wallets
    const btcAddress = document.getElementById('btcAddress');
    const displayUsdToNgn = document.getElementById('displayUsdToNgn');
    const networksList = document.getElementById('networksList');
    const newNetName = document.getElementById('newNetName');
    const newNetAddr = document.getElementById('newNetAddr');
    const addNetwork = document.getElementById('addNetwork');
    const saveWallets = document.getElementById('saveWallets');
    const walletsMsg = document.getElementById('walletsMsg');

    // Announcements
    const annTextarea = document.getElementById('annTextarea');
    const saveAnn = document.getElementById('saveAnn');
    const annMsg = document.getElementById('annMsg');

    // Proof uploads
    const proofFile = document.getElementById('proofFile');
    const proofNote = document.getElementById('proofNote');
    const uploadProofBtn = document.getElementById('uploadProofBtn');
    const proofMsg = document.getElementById('proofMsg');

    // ---------------- AUTH
    loginBtn.onclick = async () => {
      authMsg.textContent = 'Signing in...';
      try {
        await signInWithEmailAndPassword(emailEl.value.trim(), passEl.value);
        authMsg.textContent = '';
      } catch (e) {
        authMsg.textContent = 'Sign in failed: ' + (e.message || e.code);
      }
    };

    resetBtn.onclick = async () => {
      const em = (emailEl.value || '').trim();
      if (!em) { authMsg.textContent = 'Enter email first.'; return; }
      try {
        await sendPasswordResetEmail(em);
        authMsg.textContent = 'Reset link sent to ' + em;
      } catch (e) {
        authMsg.textContent = 'Reset failed: ' + (e.message || e.code);
      }
    };

    logoutBtn.onclick = async () => {
      await signOut();
      location.reload();
    };

    grantBtn.onclick = async () => {
      if (!auth.currentUser?.email) { grantMsg.textContent = 'Sign in first.'; return; }
      try {
        await setDoc(doc(db, 'admins', auth.currentUser.email), { createdAt: Date.now() }, { merge:true });
        grantMsg.textContent = 'Admin granted ✓ Reloading...';
        setTimeout(()=>location.reload(), 800);
      } catch (e) {
        grantMsg.textContent = 'Failed: ' + (e.message || e.code);
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authBlock.classList.remove('hidden');
        adminPanel.classList.add('hidden');
        notAdmin.classList.add('hidden');
        return;
      }
      const a = await getDoc(doc(db, 'admins', user.email));
      if (!a.exists()) {
        authBlock.classList.add('hidden');
        notAdmin.classList.remove('hidden');
        adminPanel.classList.add('hidden');
        return;
      }
      // authorized
      authBlock.classList.add('hidden');
      notAdmin.classList.add('hidden');
      adminPanel.classList.remove('hidden');

      await loadGlobalRates();
      await loadWalletsDoc();   // crypto + online wallet rates
      await loadAnnouncements();
      await loadGiftcards();    // brands/countries
    });

    // ---------------- GLOBAL RATES
    async function loadGlobalRates() {
      try {
        const r = await getDoc(doc(db, 'rates', 'default'));
        if (r.exists()) {
          const d = r.data();
          usdToNgn.value = d.usdToNgn ?? '';
          giftcardBase.value = d.giftcardBase ?? '';
        }
      } catch (e) { console.warn(e); }
    }

    saveRates.onclick = async () => {
      ratesMsg.textContent = 'Saving...';
      try {
        const payload = {
          usdToNgn: Number(usdToNgn.value || 0),
          giftcardBase: Number(giftcardBase.value || 0)
        };
        await setDoc(doc(db, 'rates', 'default'), payload, { merge:true });
        ratesMsg.textContent = 'Saved ✓';
        setTimeout(()=> ratesMsg.textContent = '', 1200);
      } catch (e) {
        ratesMsg.textContent = 'Error: ' + (e.message || e.code);
      }
    };

    // ---------------- GIFT CARDS
    let brands = {}; // { brandId: { displayName, enabled, countries: {US:{rate}, ...} } }

    const PRELOAD = {
      apple:   {displayName:'Apple / iTunes', enabled:true,
        countries:{ US:{rate:1450}, UK:{rate:1600}, EU:{rate:1500}, CA:{rate:1400}, AU:{rate:1350}, CH:{rate:1500} } },
      amazon:  {displayName:'Amazon', enabled:true,
        countries:{ US:{rate:1400}, UK:{rate:1580}, EU:{rate:1480}, CA:{rate:1380} } },
      google:  {displayName:'Google Play', enabled:true,
        countries:{ US:{rate:1420}, UK:{rate:1560}, EU:{rate:1460} } },
      steam:   {displayName:'Steam', enabled:true,
        countries:{ US:{rate:1380}, UK:{rate:1500}, EU:{rate:1420} } },
      visavanilla:{displayName:'Visa Vanilla', enabled:true,
        countries:{ US:{rate:1320} } },
      razergold:{displayName:'Razer Gold', enabled:true,
        countries:{ US:{rate:1360}, EU:{rate:1400} } },
      xbox:    {displayName:'Xbox', enabled:true,
        countries:{ US:{rate:1400}, UK:{rate:1540} } },
      walmart: {displayName:'Walmart', enabled:true,
        countries:{ US:{rate:1340} } },
      amex:    {displayName:'American Express', enabled:true,
        countries:{ US:{rate:1300} } },
    };

    function countryRow(brandId, code, item){
      const wrap = document.createElement('div');
      wrap.className = 'country-row';
      wrap.innerHTML = `
        <input value="${code}" placeholder="Country code (US/UK/EU/CA/AU/CH/NG)"/>
        <input type="number" value="${item?.rate ?? ''}" placeholder="Rate ₦ per $1"/>
        <button class="btn-ghost remove">Remove</button>
      `;
      const [codeEl, rateEl, rmBtn] = wrap.querySelectorAll('input,button');
      rmBtn.onclick = () => {
        delete brands[brandId].countries[codeEl.value.trim() || code];
        renderBrands();
      };
      codeEl.oninput = () => {
        const old = code;
        const neo = codeEl.value.trim().toUpperCase();
        if (!neo) return;
        if (neo!==old) {
          brands[brandId].countries[neo] = { rate: Number(rateEl.value || 0) };
          delete brands[brandId].countries[old];
        } else {
          brands[brandId].countries[old].rate = Number(rateEl.value || 0);
        }
      };
      rateEl.oninput = () => {
        const cc = (codeEl.value || code).trim().toUpperCase();
        if (!cc) return;
        brands[brandId].countries[cc] = { rate: Number(rateEl.value || 0) };
      };
      return wrap;
    }

    function brandBlock(brandId, b){
      const blk = document.createElement('div');
      blk.className = 'brand-row';
      blk.innerHTML = `
        <div class="flex" style="justify-content:space-between;">
          <div class="flex">
            <strong>${b.displayName || brandId}</strong>
            <label class="flex" style="margin-left:8px;"><input data-id="${brandId}" class="brand-enabled" type="checkbox" ${b.enabled?'checked':''}/> Enabled</label>
          </div>
          <button class="btn-danger remove-brand" data-id="${brandId}">Delete brand</button>
        </div>
        <div class="row row-3" style="margin-top:8px;">
          <div>
            <label>Brand ID</label>
            <input class="brand-id" value="${brandId}" />
          </div>
          <div>
            <label>Display name</label>
            <input class="brand-name" value="${b.displayName || ''}" placeholder="Apple / iTunes"/>
          </div>
          <div>
            <label>Add country</label>
            <input class="add-cc" placeholder="US / UK / EU / CA / AU / CH / NG"/>
          </div>
        </div>
        <div class="list cc-wrap" style="margin-top:8px;"></div>
      `;
      const ccWrap = blk.querySelector('.cc-wrap');
      // render countries
      ccWrap.innerHTML = '';
      Object.entries(b.countries || {}).forEach(([cc, obj])=>{
        ccWrap.appendChild(countryRow(brandId, cc, obj));
      });

      // hook inputs
      const idEl = blk.querySelector('.brand-id');
      const nameEl = blk.querySelector('.brand-name');
      const addCcEl = blk.querySelector('.add-cc');
      const enChk = blk.querySelector('.brand-enabled');
      const delBtn = blk.querySelector('.remove-brand');

      idEl.oninput = () => {
        const newId = idEl.value.trim().toLowerCase();
        if (!newId || newId===brandId) return;
        brands[newId] = { ...brands[brandId] };
        delete brands[brandId];
        renderBrands();
      };
      nameEl.oninput = () => { brands[brandId].displayName = nameEl.value; };
      enChk.onchange   = () => { brands[brandId].enabled = !!enChk.checked; };
      addCcEl.onkeydown = (e) => {
        if (e.key === 'Enter') {
          const cc = (addCcEl.value||'').trim().toUpperCase();
          if (!cc) return;
          brands[brandId].countries[cc] = { rate: 0 };
          addCcEl.value = '';
          renderBrands();
        }
      };
      delBtn.onclick = () => {
        delete brands[brandId];
        renderBrands();
      };

      return blk;
    }

    function renderBrands(){
      brandsWrap.innerHTML = '';
      Object.entries(brands).forEach(([id,b])=>{
        brandsWrap.appendChild(brandBlock(id,b));
      });
    }

    addBrandBtn.onclick = () => {
      const id = (newBrandId.value||'').trim().toLowerCase();
      const nm = (newBrandName.value||'').trim();
      if (!id || !nm) return;
      if (!brands[id]) brands[id] = { displayName:nm, enabled:true, countries:{} };
      newBrandId.value = '';
      newBrandName.value = '';
      renderBrands();
    };

    async function loadGiftcards(){
      brands = {};
      const snap = await getDocs(collection(db, 'giftcards'));
      if (snap.size === 0){
        // Preload once if collection empty
        brands = JSON.parse(JSON.stringify(PRELOAD));
        renderBrands();
        return;
      }
      snap.forEach(d=>{
        brands[d.id] = d.data();
        if (!brands[d.id].countries) brands[d.id].countries = {};
        if (brands[d.id].enabled === undefined) brands[d.id].enabled = true;
      });
      renderBrands();
    }

    saveAllBrands.onclick = async () => {
      brandsMsg.textContent = 'Saving...';
      try {
        // save each brand doc
        const entries = Object.entries(brands);
        for (const [id, payload] of entries){
          await setDoc(doc(db, 'giftcards', id), payload, { merge:true });
        }
        brandsMsg.textContent = 'Saved ✓';
        setTimeout(()=> brandsMsg.textContent='', 1200);
      } catch(e){
        brandsMsg.textContent = 'Error: ' + (e.message || e.code);
      }
    };

    // ---------------- ONLINE WALLET RATES + CRYPTO
    let usdtNetworks = []; // {network,address}

    function renderNetworks(){
      networksList.innerHTML = '';
      if (!usdtNetworks.length){
        networksList.innerHTML = '<div class="muted">No USDT networks yet.</div>';
        return;
      }
      usdtNetworks.forEach((n, idx)=>{
        const row = document.createElement('div');
        row.className = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.padding = '6px 0';
        row.innerHTML = `
          <div class="flex"><span class="tag">${n.network}</span><span class="muted" style="margin-left:6px;">${n.address}</span></div>
          <button data-idx="${idx}" class="btn-ghost">Remove</button>
        `;
        row.querySelector('button').onclick = (e)=>{
          const i = Number(e.currentTarget.getAttribute('data-idx'));
          usdtNetworks.splice(i,1);
          renderNetworks();
        };
        networksList.appendChild(row);
      });
    }

    addNetwork.onclick = () => {
      const net  = (newNetName.value||'').trim();
      const addr = (newNetAddr.value||'').trim();
      if (!net || !addr) return;
      usdtNetworks.push({ network:net, address:addr });
      newNetName.value = '';
      newNetAddr.value = '';
      renderNetworks();
    };

    async function loadWalletsDoc(){
      const w = await getDoc(doc(db,'wallets','default'));
      if (w.exists()){
        const d = w.data();

        // crypto
        btcAddress.value = d?.btc?.address || '';
        usdtNetworks = (d?.usdt?.networks || []).slice();
        renderNetworks();

        // display override
        displayUsdToNgn.value = d?.displayUsdToNgn || '';

        // online wallet rates
        const wr = d?.walletRates || {};
        chimeEnable.checked = !!wr?.chime?.enabled; chimeRate.value = wr?.chime?.rate ?? ''; chimeTag.value = wr?.chime?.tag || '';
        zelleEnable.checked = !!wr?.zelle?.enabled; zelleRate.value = wr?.zelle?.rate ?? ''; zelleTag.value = wr?.zelle?.tag || '';
        venmoEnable.checked = !!wr?.venmo?.enabled; venmoRate.value = wr?.venmo?.rate ?? ''; venmoTag.value = wr?.venmo?.tag || '';
        paypalEnable.checked= !!wr?.paypal?.enabled;paypalRate.value= wr?.paypal?.rate ?? '';paypalTag.value= wr?.paypal?.tag || '';
      } else {
        usdtNetworks = [];
        renderNetworks();
      }
    }

    document.getElementById('saveWalletRates').onclick = async ()=>{
      walletRatesMsg.textContent = 'Saving...';
      try{
        const payload = {
          walletRates: {
            chime:  { enabled: chimeEnable.checked,  rate: Number(chimeRate.value||0),  tag: (chimeTag.value||'').trim() },
            zelle:  { enabled: zelleEnable.checked,  rate: Number(zelleRate.value||0),  tag: (zelleTag.value||'').trim() },
            venmo:  { enabled: venmoEnable.checked,  rate: Number(venmoRate.value||0),  tag: (venmoTag.value||'').trim() },
            paypal: { enabled: paypalEnable.checked, rate: Number(paypalRate.value||0), tag: (paypalTag.value||'').trim() },
          }
        };
        await setDoc(doc(db,'wallets','default'), payload, { merge:true });
        walletRatesMsg.textContent = 'Saved ✓';
        setTimeout(()=> walletRatesMsg.textContent='', 1200);
      }catch(e){
        walletRatesMsg.textContent = 'Error: ' + (e.message || e.code);
      }
    };

    saveWallets.onclick = async ()=>{
      walletsMsg.textContent = 'Saving...';
      try{
        const payload = {
          btc:{ address:(btcAddress.value||'').trim() },
          usdt:{ networks: usdtNetworks },
          displayUsdToNgn: Number(displayUsdToNgn.value || 0) || null
        };
        await setDoc(doc(db,'wallets','default'), payload, { merge:true });
        walletsMsg.textContent = 'Saved ✓';
        setTimeout(()=> walletsMsg.textContent='', 1200);
      }catch(e){
        walletsMsg.textContent = 'Error: ' + (e.message || e.code);
      }
    };

    // ---------------- ANNOUNCEMENTS
    async function loadAnnouncements(){
      const a = await getDoc(doc(db,'announcements','default'));
      if (a.exists()){
        const d = a.data();
        annTextarea.value = Array.isArray(d.items) ? d.items.join('\n') : '';
      }
    }

    saveAnn.onclick = async ()=>{
      annMsg.textContent = 'Saving...';
      try{
        const items = (annTextarea.value||'').split('\n').map(s=>s.trim()).filter(Boolean);
        await setDoc(doc(db,'announcements','default'), { items }, { merge:true });
        annMsg.textContent = 'Saved ✓';
        setTimeout(()=> annMsg.textContent='', 1200);
      }catch(e){
        annMsg.textContent = 'Error: ' + (e.message || e.code);
      }
    };

    // ---------------- PROOF UPLOADS
    uploadProofBtn.onclick = async ()=>{
      proofMsg.textContent = 'Uploading...';
      try{
        const f = proofFile.files?.[0];
        if (!f){ proofMsg.textContent='Choose an image first.'; return; }
        const key = `proofs/${Date.now()}-${f.name}`;
        const ref = storageRef(storage, key);
        await uploadBytes(ref, f);
        const url = await getDownloadURL(ref);
        await addDoc(collection(db,'proofs'), {
          url, note:(proofNote.value||''), by: auth.currentUser?.email || null, createdAt: serverTimestamp()
        });
        proofFile.value = ''; proofNote.value='';
        proofMsg.textContent = 'Uploaded ✓';
        setTimeout(()=> proofMsg.textContent='', 1200);
      }catch(e){
        proofMsg.textContent = 'Error: ' + (e.message || e.code);
      }
    };
  </script>
</body>
</html>
