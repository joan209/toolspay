<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Toolspay — Admin</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<header class="topbar dark">
  <div class="brand">Toolspay — Admin</div>
  <div class="spacer"></div>
  <button id="logoutBtn" class="btn-ghost">Sign out</button>
</header>

<main class="container">
  <section id="authBlock" class="card">
    <h2>Admin sign in</h2>
    <div class="row">
      <input id="email" type="email" placeholder="you@example.com"/>
      <input id="password" type="password" placeholder="••••••••"/>
      <button id="loginBtn" class="btn-primary">Sign in</button>
      <button id="resetBtn" class="btn-ghost">Reset link</button>
    </div>
    <div id="authMsg" class="muted"></div>
  </section>

  <section id="notAdmin" class="card hidden">
    <h3 class="danger">Not authorized</h3>
    <a class="btn-primary" href="grant-admin.html">Open grant-admin</a>
  </section>

  <section id="panel" class="hidden">
    <!-- Announcements -->
    <div class="card">
      <h2>Announcements</h2>
      <textarea id="annTextarea" rows="4" placeholder="One per line"></textarea>
      <button id="saveAnn" class="btn-primary">Save</button>
      <span id="annMsg" class="muted"></span>
    </div>

    <!-- Wallets -->
    <div class="card">
      <h2>Crypto Wallets</h2>
      <div class="row">
        <input id="btcAddress" placeholder="BTC address"/>
      </div>
      <div class="subcard">
        <h3>USDT Networks</h3>
        <div id="nets"></div>
        <div class="row">
          <input id="netName" placeholder="TRC20 / ERC20 / BEP20"/>
          <input id="netAddr" placeholder="USDT address"/>
          <button id="addNet" class="btn-ghost">Add</button>
        </div>
      </div>
      <button id="saveWallets" class="btn-primary">Save</button>
      <span id="wMsg" class="muted"></span>
    </div>

    <!-- Gift card rates -->
    <div class="card">
      <h2>Gift Card Rates (₦ per $1)</h2>
      <div class="row">
        <select id="gcBrand">
          <option>Amazon</option><option>iTunes</option><option>Steam</option><option>Google Play</option>
          <option>Walmart</option><option>Razer Gold</option><option>Vanilla Visa</option><option>Amex</option>
        </select>
        <select id="gcCountry">
          <option>USA</option><option>UK</option><option>Canada</option><option>Australia</option><option>EU</option><option>Switzerland</option>
        </select>
        <input id="gcRate" type="number" placeholder="e.g. 1450"/>
        <button id="saveGcRate" class="btn-primary">Add/Update</button>
      </div>
      <div id="gcRatesList" class="list"></div>
    </div>

    <!-- Online wallet rates -->
    <div class="card">
      <h2>Online Wallet Rates (₦ per $1)</h2>
      <div class="row">
        <select id="owType"><option>Chime</option><option>Zelle</option><option>Venmo</option><option>PayPal</option></select>
        <select id="owCountry">
          <option>USA</option><option>UK</option><option>Canada</option><option>Australia</option><option>EU</option><option>Switzerland</option>
        </select>
        <input id="owRate" type="number" placeholder="e.g. 1300"/>
        <button id="saveOwRate" class="btn-primary">Add/Update</button>
      </div>
      <div id="owRatesList" class="list"></div>
    </div>

    <!-- Trades -->
    <div class="card">
      <h2>Trades</h2>
      <div id="tradesList" class="list"></div>
    </div>

    <!-- Withdraw requests -->
    <div class="card">
      <h2>Withdraw Requests</h2>
      <div id="wdList" class="list"></div>
    </div>
  </section>
</main>

<script type="module">
  import {
    auth, db, storage,
    onAuthStateChanged, signInWithEmailAndPassword, signOut, sendPasswordResetEmail,
    isAdminEmail, addAdminByEmail,
    doc, getDoc, setDoc, updateDoc, addDoc, collection, getDocs, deleteField, serverTimestamp,
    ref, uploadBytes, getDownloadURL
  } from './firebase-auth.js';

  // UI refs
  const authBlock = document.getElementById('authBlock');
  const notAdmin = document.getElementById('notAdmin');
  const panel = document.getElementById('panel');
  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const loginBtn = document.getElementById('loginBtn');
  const resetBtn = document.getElementById('resetBtn');
  const authMsg = document.getElementById('authMsg');
  document.getElementById('logoutBtn').onclick = async ()=>{ await signOut(auth); location.reload(); };

  loginBtn.onclick = async ()=>{
    authMsg.textContent='...';
    try {
      await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
      authMsg.textContent='';
    } catch(e){ authMsg.textContent=e.message||e.code; }
  };
  resetBtn.onclick = async ()=>{
    if (!email.value.trim()){ authMsg.textContent='Enter email first'; return; }
    try { await sendPasswordResetEmail(auth, email.value.trim()); authMsg.textContent='Reset link sent'; }
    catch(e){ authMsg.textContent=e.message||e.code; }
  };

  onAuthStateChanged(auth, async (user)=>{
    if (!user){ authBlock.classList.remove('hidden'); panel.classList.add('hidden'); notAdmin.classList.add('hidden'); return; }
    const ok = await isAdminEmail(user.email);
    if (!ok){ authBlock.classList.add('hidden'); notAdmin.classList.remove('hidden'); panel.classList.add('hidden'); return; }
    authBlock.classList.add('hidden'); notAdmin.classList.add('hidden'); panel.classList.remove('hidden');
    loadAnnouncements();
    loadWallets();
    loadGiftCardRates();
    loadOnlineWalletRates();
    loadTrades();
    loadWithdraws();
  });

  // Announcements
  const annTextarea = document.getElementById('annTextarea');
  const annMsg = document.getElementById('annMsg');
  document.getElementById('saveAnn').onclick = async ()=>{
    annMsg.textContent='Saving...';
    const items = annTextarea.value.split('\n').map(s=>s.trim()).filter(Boolean);
    await setDoc(doc(db,'announcements','default'),{ items },{merge:true});
    annMsg.textContent='Saved ✓'; setTimeout(()=>annMsg.textContent='',1000);
  };
  async function loadAnnouncements(){
    const a = await getDoc(doc(db,'announcements','default'));
    if (a.exists()){ annTextarea.value=(a.data().items||[]).join('\n'); }
  }

  // Wallets (BTC + USDT networks)
  const wMsg = document.getElementById('wMsg');
  const btcAddress = document.getElementById('btcAddress');
  const netsDiv = document.getElementById('nets');
  const nets = [];
  document.getElementById('addNet').onclick = ()=>{
    const name=document.getElementById('netName').value.trim();
    const addr=document.getElementById('netAddr').value.trim();
    if (!name||!addr) return;
    nets.push({network:name,address:addr});
    renderNets();
    document.getElementById('netName').value='';
    document.getElementById('netAddr').value='';
  };
  function renderNets(){
    netsDiv.innerHTML='';
    if (nets.length===0){ netsDiv.innerHTML='<div class="muted">No networks yet.</div>'; return; }
    nets.forEach((n,i)=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`<div class="chip">${n.network}</div><div class="muted">${n.address}</div>
      <button class="btn-ghost" data-i="${i}">Remove</button>`;
      row.querySelector('button').onclick=(e)=>{ nets.splice(Number(e.target.dataset.i),1); renderNets(); };
      netsDiv.appendChild(row);
    });
  }
  async function loadWallets(){
    const s=await getDoc(doc(db,'wallets','default'));
    if (s.exists()){
      const d=s.data();
      btcAddress.value = d?.btc?.address || '';
      (d?.usdt?.networks||[]).forEach(x=>nets.push(x));
      renderNets();
    }
  }
  document.getElementById('saveWallets').onclick = async ()=>{
    wMsg.textContent='Saving...';
    await setDoc(doc(db,'wallets','default'),{
      btc:{ address: (btcAddress.value||'').trim() },
      usdt:{ networks: nets }
    },{merge:true});
    wMsg.textContent='Saved ✓'; setTimeout(()=>wMsg.textContent='',1000);
  };

  // Gift card rates per brand/country (document id: Brand__Country)
  const gcRatesList=document.getElementById('gcRatesList');
  async function loadGiftCardRates(){
    gcRatesList.innerHTML='';
    const brands=['Amazon','iTunes','Steam','Google Play','Walmart','Razer Gold','Vanilla Visa','Amex'];
    const countries=['USA','UK','Canada','Australia','EU','Switzerland'];
    for (const b of brands){
      for (const c of countries){
        const id=`${b}__${c}`;
        const s=await getDoc(doc(db,'giftCardRates',id));
        if (s.exists()){
          const row=document.createElement('div'); row.className='row';
          row.innerHTML=`<div class="chip">${b} (${c})</div><div>₦${s.data().rateNgnPerUsd}/$</div>`;
          gcRatesList.appendChild(row);
        }
      }
    }
  }
  document.getElementById('saveGcRate').onclick = async ()=>{
    const b=document.getElementById('gcBrand').value;
    const c=document.getElementById('gcCountry').value;
    const r=Number(document.getElementById('gcRate').value||0);
    if (!b||!c||r<=0) return;
    await setDoc(doc(db,'giftCardRates',`${b}__${c}`),{ brand:b, country:c, rateNgnPerUsd:r, updatedAt: serverTimestamp() },{merge:true});
    await loadGiftCardRates();
  };

  // Online wallet rates (Chime/Zelle/Venmo/PayPal)
  const owRatesList=document.getElementById('owRatesList');
  async function loadOnlineWalletRates(){
    owRatesList.innerHTML='';
    const types=['Chime','Zelle','Venmo','PayPal'];
    const countries=['USA','UK','Canada','Australia','EU','Switzerland'];
    for (const t of types){
      for (const c of countries){
        const id=`${t}__${c}`;
        const s=await getDoc(doc(db,'walletRates',id));
        if (s.exists()){
          const row=document.createElement('div'); row.className='row';
          row.innerHTML=`<div class="chip">${t} (${c})</div><div>₦${s.data().rateNgnPerUsd}/$</div>`;
          owRatesList.appendChild(row);
        }
      }
    }
  }
  document.getElementById('saveOwRate').onclick = async ()=>{
    const t=document.getElementById('owType').value;
    const c=document.getElementById('owCountry').value;
    const r=Number(document.getElementById('owRate').value||0);
    if (!t||!c||r<=0) return;
    await setDoc(doc(db,'walletRates',`${t}__${c}`),{ type:t, country:c, rateNgnPerUsd:r, updatedAt: serverTimestamp() },{merge:true});
    await loadOnlineWalletRates();
  };

  // Trades moderation
  const tradesList=document.getElementById('tradesList');
  async function loadTrades(){
    tradesList.innerHTML='';
    const ts = await getDocs(collection(db,'trades'));
    ts.forEach(docu=>{
      const d=docu.data();
      const div=document.createElement('div'); div.className='subcard';
      const imgs = (d.images||[]).map(u=>`<a href="${u}" target="_blank">image</a>`).join(' · ');
      div.innerHTML = `
        <div><b>${d.type}</b> — ${d.email||''} — <span class="chip">${d.status||''}</span></div>
        <div class="muted">${d.brand||d.cryptoType||''} ${d.country||d.network||''} ${d.faceUsd||d.amountUsd||''}</div>
        <div>${imgs}</div>
        <div class="row">
          <input type="file" id="proof_${docu.id}" accept="image/*"/>
          <button class="btn-ghost" data-id="${docu.id}" data-what="reject">Reject</button>
          <button class="btn-primary" data-id="${docu.id}" data-what="paid">Mark Paid</button>
        </div>
      `;
      tradesList.appendChild(div);
      div.querySelectorAll('button').forEach(btn=>{
        btn.onclick = async ()=>{
          const what = btn.dataset.what; const id = btn.dataset.id;
          let proofUrl=null;
          const f = document.getElementById(`proof_${id}`)?.files?.[0];
          if (f){
            const r = ref(storage, `proofs/${id}_${Date.now()}_${f.name}`);
            await uploadBytes(r,f); proofUrl = await getDownloadURL(r);
          }
          const refDoc = doc(db,'trades',id);
          const s=await getDoc(refDoc);
          const trade = s.data();
          if (what==='paid'){
            await updateDoc(refDoc,{ status:'Paid', proof:proofUrl||null, paidAt: serverTimestamp() });
            // credit balance
            const uid = trade.uid;
            const amountNgn = await estimatePayoutNgn(trade); // calc from stored rate
            await creditUser(uid, amountNgn, `Trade ${id}`);
          } else {
            await updateDoc(refDoc,{ status:'Rejected', proof:proofUrl||null });
          }
          await loadTrades();
        };
      });
    });
  }
  async function estimatePayoutNgn(trade){
    if (trade.type==='giftcard'){
      const id=`${trade.brand}__${trade.country}`;
      const s=await getDoc(doc(db,'giftCardRates',id));
      const rate= s.exists()? Number(s.data().rateNgnPerUsd||0):0;
      return Math.round(rate*Number(trade.faceUsd||0));
    }
    if (trade.type==='crypto'){
      const r=await getDoc(doc(db,'rates','default'));
      const rate= r.exists()? Number(r.data()?.usdToNgn||0):0;
      return Math.round(rate*Number(trade.amountUsd||0));
    }
    return 0;
  }
  async function creditUser(uid, amount, reason){
    const uRef=doc(db,'users',uid);
    const s=await getDoc(uRef);
    const bal=Number(s.data()?.balanceNgn||0);
    await updateDoc(uRef,{ balanceNgn: bal + Number(amount) });
    await addDoc(collection(db,'users',uid,'balanceHistory'),{
      change: Number(amount), reason, createdAt: serverTimestamp()
    });
  }

  // Withdraws
  const wdList=document.getElementById('wdList');
  async function loadWithdraws(){
    wdList.innerHTML='';
    const qs=await getDocs(collection(db,'withdrawRequests'));
    qs.forEach(x=>{
      const d=x.data();
      const row=document.createElement('div'); row.className='subcard';
      row.innerHTML=`
        <div>${d.email} — ₦${d.amountNgn} — <span class="chip">${d.status}</span></div>
        <div class="muted">${d.bank?.bankName||''} • ${d.bank?.accountName||''} • ${d.bank?.accountNumber||''}</div>
        <div class="row">
          <button class="btn-primary" data-id="${x.id}" data-do="pay">Mark Paid</button>
          <button class="btn-ghost" data-id="${x.id}" data-do="reject">Reject</button>
        </div>
      `;
      wdList.appendChild(row);
      row.querySelectorAll('button').forEach(b=>{
        b.onclick = async ()=>{
          const id=b.dataset.id; const todo=b.dataset.do;
          const refDoc=doc(db,'withdrawRequests',id);
          const s=await getDoc(refDoc); const d=s.data();
          if (todo==='pay'){
            // debit user balance
            const u=doc(db,'users',d.uid); const us=await getDoc(u);
            const bal=Number(us.data()?.balanceNgn||0);
            const nb=Math.max(0, bal - Number(d.amountNgn||0));
            await updateDoc(u,{ balanceNgn: nb });
            await addDoc(collection(db,'users',d.uid,'balanceHistory'),{
              change: -Number(d.amountNgn||0), reason:'Withdraw paid', createdAt: serverTimestamp()
            });
            await updateDoc(refDoc,{ status:'Paid', paidAt: serverTimestamp() });
          } else {
            await updateDoc(refDoc,{ status:'Rejected' });
          }
          await loadWithdraws();
        };
      });
    });
  }
</script>
</body>
</html>
