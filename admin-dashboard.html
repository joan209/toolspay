<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f7f8fa;
    padding: 20px;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #111;
    color: #fff;
    padding: 10px 20px;
  }
  h1 {
    font-size: 1.5em;
  }
  button {
    padding: 8px 12px;
    background: crimson;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }
  section {
    margin-top: 20px;
    background: white;
    padding: 15px;
    border-radius: 8px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  table, th, td {
    border: 1px solid #ccc;
  }
  th, td {
    padding: 8px;
    text-align: left;
  }
  input, select {
    padding: 5px;
    margin: 5px 0;
    width: 100%;
  }
</style>
</head>
<body>
<header>
  <h1>Admin Dashboard</h1>
  <div>
    <span id="adminEmail"></span>
    <button id="logoutBtn">Logout</button>
  </div>
</header>

<section>
  <h2>Gift Card Rates Management</h2>
  <form id="giftCardForm">
    <input type="text" id="giftCardName" placeholder="Gift Card Name" required />
    <input type="number" id="giftCardRate" placeholder="Rate" required />
    <input type="text" id="giftCardCountry" placeholder="Country" required />
    <button type="submit">Add / Update Gift Card</button>
  </form>
  <table id="giftCardTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Rate</th>
        <th>Country</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>Online Wallet Rates Management</h2>
  <form id="walletForm">
    <input type="text" id="walletName" placeholder="Wallet Name" required />
    <input type="number" id="walletRate" placeholder="Rate" required />
    <button type="submit">Add / Update Wallet</button>
  </form>
  <table id="walletTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Rate</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<section>
  <h2>Crypto Wallet Management</h2>
  <form id="cryptoForm">
    <select id="cryptoType">
      <option value="BTC">BTC</option>
      <option value="USDT">USDT</option>
    </select>
    <input type="text" id="cryptoAddress" placeholder="Wallet Address" required />
    <input type="file" id="cryptoQR" />
    <button type="submit">Save Crypto Wallet</button>
  </form>
  <div id="cryptoList"></div>
</section>

<section>
  <h2>Countries List</h2>
  <form id="countryForm">
    <input type="text" id="countryName" placeholder="Country Name" required />
    <button type="submit">Add Country</button>
  </form>
  <ul id="countryList"></ul>
</section>

<section>
  <h2>Processing Time</h2>
  <input type="text" id="processingTime" placeholder="e.g., 5-10 minutes" />
  <button id="saveProcessingTime">Save</button>
</section>

<section>
  <h2>Customer Balances & History</h2>
  <div id="customerBalances"></div>
</section>

<script type="module" src="./firebase.js"></script>
<script type="module">
import {
  auth, db, storage,
  signOut, onAuthStateChanged,
  doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs,
  collection, addDoc, serverTimestamp,
  uploadFileReturnURL
} from './firebase.js';

// ===== Check if logged in =====
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'admin-login.html';
  } else {
    document.getElementById('adminEmail').textContent = user.email;
    loadGiftCards();
    loadWallets();
    loadCrypto();
    loadCountries();
    loadProcessingTime();
    loadCustomerBalances();
  }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
});

// ===== Gift Card CRUD =====
async function loadGiftCards() {
  const snap = await getDocs(collection(db, "giftCards"));
  const tbody = document.querySelector('#giftCardTable tbody');
  tbody.innerHTML = '';
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.name}</td>
      <td>${data.rate}</td>
      <td>${data.country}</td>
      <td><button onclick="deleteGiftCard('${docSnap.id}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}
window.deleteGiftCard = async (id) => {
  await deleteDoc(doc(db, "giftCards", id));
  loadGiftCards();
};
document.getElementById('giftCardForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = giftCardName.value.trim();
  const rate = parseFloat(giftCardRate.value);
  const country = giftCardCountry.value.trim();
  await setDoc(doc(db, "giftCards", `${name}_${country}`), {
    name, rate, country, updatedAt: serverTimestamp()
  });
  e.target.reset();
  loadGiftCards();
});

// ===== Wallet CRUD =====
async function loadWallets() {
  const snap = await getDocs(collection(db, "wallets"));
  const tbody = document.querySelector('#walletTable tbody');
  tbody.innerHTML = '';
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.name}</td>
      <td>${data.rate}</td>
      <td><button onclick="deleteWallet('${docSnap.id}')">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}
window.deleteWallet = async (id) => {
  await deleteDoc(doc(db, "wallets", id));
  loadWallets();
};
document.getElementById('walletForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = walletName.value.trim();
  const rate = parseFloat(walletRate.value);
  await setDoc(doc(db, "wallets", name), { name, rate, updatedAt: serverTimestamp() });
  e.target.reset();
  loadWallets();
});

// ===== Crypto Wallets =====
async function loadCrypto() {
  const snap = await getDocs(collection(db, "cryptoWallets"));
  const list = document.getElementById('cryptoList');
  list.innerHTML = '';
  snap.forEach(docSnap => {
    const data = docSnap.data();
    list.innerHTML += `<p>${data.type}: ${data.address}<br><img src="${data.qr}" width="100" /></p>`;
  });
}
document.getElementById('cryptoForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const type = cryptoType.value;
  const address = cryptoAddress.value.trim();
  let qrUrl = "";
  if (cryptoQR.files.length) {
    qrUrl = await uploadFileReturnURL(cryptoQR.files[0], "cryptoQRs");
  }
  await setDoc(doc(db, "cryptoWallets", type), { type, address, qr: qrUrl });
  e.target.reset();
  loadCrypto();
});

// ===== Countries =====
async function loadCountries() {
  const snap = await getDocs(collection(db, "countries"));
  const list = document.getElementById('countryList');
  list.innerHTML = '';
  snap.forEach(docSnap => {
    const data = docSnap.data();
    const li = document.createElement('li');
    li.innerHTML = `${data.name} <button onclick="deleteCountry('${docSnap.id}')">Remove</button>`;
    list.appendChild(li);
  });
}
window.deleteCountry = async (id) => {
  await deleteDoc(doc(db, "countries", id));
  loadCountries();
};
document.getElementById('countryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = countryName.value.trim();
  await setDoc(doc(db, "countries", name), { name });
  e.target.reset();
  loadCountries();
});

// ===== Processing Time =====
async function loadProcessingTime() {
  const ref = doc(db, "settings", "processingTime");
  const snap = await getDoc(ref);
  if (snap.exists()) {
    processingTime.value = snap.data().value;
  }
}
document.getElementById('saveProcessingTime').addEventListener('click', async () => {
  await setDoc(doc(db, "settings", "processingTime"), { value: processingTime.value });
  alert('Processing time saved.');
});

// ===== Customer Balances =====
async function loadCustomerBalances() {
  const snap = await getDocs(collection(db, "users"));
  const div = document.getElementById('customerBalances');
  div.innerHTML = '';
  snap.forEach(docSnap => {
    const u = docSnap.data();
    div.innerHTML += `<p>${u.email} â€” Balance: ${u.balance || 0}</p>`;
  });
}
</script>
</body>
</html>
