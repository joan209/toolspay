<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Toolspay â€” Customer</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{
    --bg: #f7f7f8; /* start light by default - user requested start with light mode */
    --card:#ffffff; --text:#111827; --muted:#6b7280; --brand:#b58900;
    --ok:#059669; --danger:#b91c1c; --border:#e5e7eb; --chip:#f3f4f6;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0b1220; --card: #0f172a; --text: #e2e8f0; --muted:#94a3b8; --brand:#ffd700;
      --ok:#10b981; --danger:#ef4444; --border:#1f2937; --chip:#111827;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .row{display:grid;gap:10px}
  @media(min-width:720px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
  label{font-size:13px;font-weight:700;opacity:.85}
  input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:15px}
  input[type="file"]{padding:8px;background:transparent}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn{background:#111;color:var(--brand);border:2px solid var(--brand)}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn-muted{background:var(--chip);color:var(--text);border:1px solid var(--border)}
  .muted{color:var(--muted);font-size:13px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .chip{padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:12px}
  .money{font-weight:800}
  .brand-badge{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#111,#ffd700);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
  .center{display:flex;align-items:center;justify-content:center}
  /* Splash */
  #splash{position:fixed;inset:0;background:var(--bg);z-index:500;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;transition:opacity .25s ease}
  #splash.fade{opacity:0;pointer-events:none}
  #splash .tp{font-size:28px;font-weight:900;border:2px solid var(--brand);color:var(--brand);padding:12px 18px;border-radius:12px}
  .qr{background:#fff;border-radius:12px;padding:10px}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .toolbar{position:sticky;top:0;background:var(--bg);z-index:99;border-bottom:1px solid var(--border)}
  .nav { display:flex; gap:10px; align-items:center; }
  .nav a { color:var(--text); text-decoration:none; padding:8px 10px; border-radius:8px; }
  .nav a.active { background:var(--chip); border:1px solid var(--border); }
  /* Center auth on mobile */
  #authView{max-width:520px;margin:12vh auto 6vh}
  @media (max-width:520px){
    #authView{margin:14vh 12px 8vh}
    #authView h2{font-size:22px;margin:0 0 8px}
    .row-2{grid-template-columns:1fr}
  }
  /* small helper */
  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="tp">TP</div>
  <div class="muted">Loading dashboardâ€¦</div>
</div>

<!-- Top bar / nav -->
<header class="toolbar">
  <div class="container header">
    <div class="flex">
      <div class="brand-badge">TP</div>
      <div>
        <div style="font-weight:800;">Toolspay</div>
        <div class="muted">Sell Gift Cards â€¢ BTC â€¢ USDT â†’ Get paid in â‚¦</div>
      </div>
    </div>

    <nav class="nav right">
      <a id="navTrades" href="#" class="active">Gift Cards</a>
      <a id="navCrypto" href="#">Crypto</a>
      <a id="navWallets" href="#">Wallets</a>
      <a id="navWithdraw" href="#">Withdraw</a>
      <a id="navProfile" href="profile.html" class="hidden">Profile</a>
      <button id="modeBtn" class="btn-ghost" title="Dark/Light" type="button">ðŸŒ“</button>
      <button id="openChatBtn" class="btn-ghost" title="Chat admin" type="button">ðŸ’¬</button>
      <button id="logoutBtn" class="btn-ghost hidden" type="button">Sign out</button>
    </nav>
  </div>
</header>

<main class="container">
  <!-- AUTH VIEW (Sign in / Sign up toggle) -->
  <section id="authView" class="card hidden">
    <h2 style="font-weight:900;">Welcome</h2>
    <p class="muted">Sign in to trade or click "Create account" to register.</p>

    <div style="display:flex;gap:8px;margin:12px 0;">
      <button id="showSignIn" class="btn">Sign in</button>
      <button id="showSignUp" class="btn-ghost">Create account</button>
    </div>

    <!-- SIGN IN -->
    <div id="signInBox">
      <div class="row" style="margin-top:6px;">
        <div><label>Email</label><input id="siEmail" type="email" placeholder="you@example.com" autocomplete="email"></div>
        <div><label>Password</label><input id="siPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="signInBtn" class="btn">Sign in</button>
        <button id="toForgot" class="btn-ghost">Forgot password</button>
      </div>
      <div class="muted" id="siMsg" style="margin-top:8px"></div>
    </div>

    <!-- SIGN UP -->
    <div id="signUpBox" class="hidden">
      <div class="row" style="margin-top:6px;">
        <div><label>Full name</label><input id="suName" type="text" placeholder="John Doe" autocomplete="name"></div>
        <div><label>Username</label><input id="suUsername" type="text" placeholder="username"></div>
        <div><label>Email</label><input id="suEmail" type="email" placeholder="you@example.com" autocomplete="email"></div>
        <div><label>Password</label><input id="suPass" type="password" placeholder="Create a password" autocomplete="new-password"></div>
        <div><label>Confirm password</label><input id="suPass2" type="password" placeholder="Confirm password"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="signUpBtn" class="btn">Create account</button>
        <button id="showSignInFromUp" class="btn-ghost">Back to sign in</button>
      </div>
      <div class="muted" id="suMsg" style="margin-top:8px"></div>
    </div>

    <!-- FORGOT -->
    <div id="forgotBox" class="hidden">
      <div class="row" style="margin-top:6px;">
        <div><label>Email</label><input id="fgEmail" type="email" placeholder="you@example.com"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="forgotBtn" class="btn">Send reset link</button>
        <button id="backToSignIn" class="btn-ghost">Back</button>
      </div>
      <div class="muted" id="fgMsg" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- DASHBOARD (visible after login) -->
  <section id="dashView" class="hidden">
    <!-- Quick header -->
    <div class="card">
      <div class="header">
        <div>
          <div class="muted">Welcome back, <span id="userNameDisplay" style="font-weight:800">User</span></div>
          <div class="small">Available balance</div>
          <div id="balNgn" class="money" style="font-size:22px">â‚¦0</div>
        </div>
        <div class="flex">
          <button id="btnToggleHistory" class="btn-ghost">Toggle history</button>
        </div>
      </div>
    </div>

    <!-- Main content: Gift cards selected by default -->
    <div id="contentArea">
      <!-- Gift cards view -->
      <div id="view-gift" class="card">
        <h3>Sell Gift Cards</h3>
        <div class="row row-3">
          <div>
            <label>Brand</label>
            <select id="giftBrand"></select>
          </div>
          <div>
            <label>Country</label>
            <select id="giftCountry"></select>
          </div>
          <div>
            <label>Face value ($)</label>
            <input id="giftAmount" type="number" placeholder="100"/>
          </div>
        </div>
        <div class="row row-2" style="margin-top:10px;">
          <div>
            <label>Upload card images (JPG/PNG, up to 5)</label>
            <input id="giftFiles" type="file" accept="image/*" multiple/>
            <div class="muted">Optional: add receipt images too.</div>
          </div>
          <div>
            <label>Estimated payout (â‚¦)</label>
            <input id="giftEstimate" disabled placeholder="â‚¦0"/>
            <div class="muted">Uses admin rates for selected brand & country.</div>
          </div>
        </div>
        <div style="margin-top:10px;" class="flex">
          <button id="submitGift" class="btn">Submit gift card</button>
          <div class="muted" id="giftMsg" style="margin-left:10px"></div>
        </div>
      </div>

      <!-- Crypto view -->
      <div id="view-crypto" class="card hidden">
        <h3>Sell Crypto</h3>
        <div class="row row-3">
          <div>
            <label>Crypto</label>
            <select id="cryptoType"><option value="BTC">BTC</option><option value="USDT">USDT</option></select>
          </div>
          <div>
            <label>Network (USDT)</label>
            <select id="usdtNet"><option value="">â€”</option></select>
            <div class="muted">If BTC, network not needed.</div>
          </div>
          <div>
            <label>Amount</label>
            <input id="cryptoAmount" type="number" placeholder="0.100"/>
          </div>
        </div>
        <div class="row row-2" style="margin-top:10px;">
          <div>
            <label>Send to this address</label>
            <input id="cryptoAddress" disabled/>
            <div class="flex" style="margin-top:8px;">
              <button id="copyAddr" class="btn-ghost">Copy address</button>
            </div>
          </div>
          <div>
            <label>QR</label>
            <div id="qrBox" class="qr center"></div>
            <div class="muted">Scan in your wallet app.</div>
          </div>
        </div>
        <div style="margin-top:10px;" class="flex">
          <button id="markCryptoSent" class="btn">Iâ€™ve sent the crypto</button>
          <div class="muted" id="cryptoMsg" style="margin-left:10px"></div>
        </div>
      </div>

      <!-- Online wallets view -->
      <div id="view-wallet" class="card hidden">
        <h3>Sell via Online Wallet</h3>
        <div class="row row-3">
          <div><label>Wallet type</label><select id="owType"></select></div>
          <div><label>Country</label><select id="owCountry"></select></div>
          <div><label>Amount (USD)</label><input id="owAmount" type="number" placeholder="100"/></div>
        </div>
        <div class="row row-2" style="margin-top:10px;">
          <div><label>Estimated payout (â‚¦)</label><input id="owEstimate" disabled placeholder="â‚¦0"/></div>
          <div>
            <label>Next step</label>
            <div class="flex"><button id="openChatForTag" class="btn-ghost">ðŸ’¬ Chat admin for tag</button><div class="muted">Ask admin for the exact tag to pay.</div></div>
          </div>
        </div>
        <div style="margin-top:10px;" class="flex">
          <button id="submitOW" class="btn">Iâ€™ve sent the money</button>
          <div class="muted" id="owMsg" style="margin-left:10px"></div>
        </div>
      </div>

      <!-- Withdraw view -->
      <div id="view-withdraw" class="card hidden">
        <h3>Withdraw</h3>
        <div class="row row-3">
          <div><label>Available (â‚¦)</label><input id="wdAvail" disabled/></div>
          <div><label>Amount (â‚¦)</label><input id="wdAmount" type="number" placeholder="5000"/></div>
          <div><label>&nbsp;</label><button id="reqWithdraw" class="btn">Request withdraw</button></div>
        </div>
        <div class="muted" id="wdMsg" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- History (toggle) -->
    <div id="historyWrap" class="card hidden">
      <div class="header"><h3>History</h3></div>
      <div id="history" class="row"></div>
    </div>
  </section>
</main>

<!-- Firebase + App (module) -->
<script type="module">
/* ================== FIREBASE SDK ================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  sendPasswordResetEmail, signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* ===== YOUR FIREBASE CONFIG (from you) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyD-BIOpzkQBtpW1LQk7Rf3c-ZvyIbvEc7c",
  authDomain: "toolspay-54167.firebaseapp.com",
  projectId: "toolspay-54167",
  storageBucket: "toolspay-54167.firebasestorage.app",
  messagingSenderId: "71318117342",
  appId: "1:71318117342:web:1952711453e19e19281b4f"
};
/* ============================================ */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ---------- small helpers ---------- */
const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const currency = n => 'â‚¦' + Number(n||0).toLocaleString();

/* Splash handling */
const splash = $('splash');
function hideSplashNow(){ splash.classList.add('fade'); setTimeout(()=>splash.classList.add('hidden'),250); }

/* Mode toggle */
$('modeBtn').onclick = ()=>{
  const cur = document.documentElement.getAttribute('data-theme');
  if(cur==='dark'){ document.documentElement.removeAttribute('data-theme'); /* light */ }
  else { document.documentElement.setAttribute('data-theme','dark'); }
  // Also flip CSS prefers override
  if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
    // If OS already dark, toggling simply override by setting data-theme
  }
};

/* Chat open (Tawk or other widget if added) */
function openTawk(){ try{ window.Tawk_API?.maximize(); }catch(e){} }
$('openChatBtn').onclick = openTawk;
$('openChatForTag').onclick = openTawk;

/* Tabs/navigation */
const NAV = {
  trades: $('navTrades'),
  crypto: $('navCrypto'),
  wallets: $('navWallets'),
  withdraw: $('navWithdraw'),
  profileLink: $('navProfile')
};
function clearViews(){
  ['view-gift','view-crypto','view-wallet','view-withdraw'].forEach(id=>$(id).classList.add('hidden'));
  Object.values(NAV).forEach(a=>a.classList.remove('active'));
}
NAV.trades.onclick = (e)=>{ e.preventDefault(); clearViews(); $('view-gift').classList.remove('hidden'); NAV.trades.classList.add('active'); };
NAV.crypto.onclick  = (e)=>{ e.preventDefault(); clearViews(); $('view-crypto').classList.remove('hidden'); NAV.crypto.classList.add('active'); };
NAV.wallets.onclick = (e)=>{ e.preventDefault(); clearViews(); $('view-wallet').classList.remove('hidden'); NAV.wallets.classList.add('active'); };
NAV.withdraw.onclick = (e)=>{ e.preventDefault(); clearViews(); $('view-withdraw').classList.remove('hidden'); NAV.withdraw.classList.add('active'); };

/* ---------------------------------- Global state ---------------------------------- */
let currentUser = null;
let usdToNgn = 0;
let giftRates = {};
let walletRateMap = {};
let btcAddress = '';
let usdtNetworks = [];
let procTimeMap = {};

/* DOM refs used often */
const authView = $('authView'), dashView = $('dashView');
/* auth */
const showSignIn = $('showSignIn'), showSignUp = $('showSignUp');
const signInBox = $('signInBox'), signUpBox = $('signUpBox'), forgotBox = $('forgotBox');
const siEmail = $('siEmail'), siPass = $('siPass'), siMsg = $('siMsg');
const suName = $('suName'), suUsername = $('suUsername'), suEmail = $('suEmail'), suPass = $('suPass'), suPass2 = $('suPass2'), suMsg = $('suMsg');
const fgEmail = $('fgEmail'), fgMsg = $('fgMsg');
/* actions */
const signUpBtnEl = $('signUpBtn'), signInBtnEl = $('signInBtn'), forgotBtnEl = $('forgotBtn');
const logoutBtn = $('logoutBtn');
/* dashboard */
const balNgn = $('balNgn'), userNameDisplay = $('userNameDisplay'), historyWrap = $('historyWrap'), historyBox = $('history');
const btnToggleHistory = $('btnToggleHistory');
/* gift */
const giftBrand = $('giftBrand'), giftCountry = $('giftCountry'), giftAmount = $('giftAmount'), giftFiles = $('giftFiles'), giftEstimate = $('giftEstimate'), submitGift = $('submitGift'), giftMsg = $('giftMsg');
/* crypto */
const cryptoType = $('cryptoType'), usdtNet = $('usdtNet'), cryptoAmount = $('cryptoAmount'), cryptoAddress = $('cryptoAddress'), qrBox = $('qrBox'), copyAddr = $('copyAddr'), markCryptoSent = $('markCryptoSent'), cryptoMsg = $('cryptoMsg');
/* wallet */
const owType = $('owType'), owCountry = $('owCountry'), owAmount = $('owAmount'), owEstimate = $('owEstimate'), submitOW = $('submitOW'), owMsg = $('owMsg');
/* withdraw */
const wdAvail = $('wdAvail'), wdAmount = $('wdAmount'), reqWithdraw = $('reqWithdraw'), wdMsg = $('wdMsg');

/* ----------------- Simple QR render ----------------- */
function renderQR(target, text){
  target.innerHTML = '';
  if(!text){ target.textContent = 'â€”'; return; }
  const img = new Image(); img.alt='QR'; img.style.maxWidth='160px';
  img.src = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(text)}`;
  img.onerror = ()=>{ target.textContent = text; };
  target.appendChild(img);
}

/* ----------------- Auth UI toggle handlers ----------------- */
showSignIn.onclick = ()=>{ signInBox.classList.remove('hidden'); signUpBox.classList.add('hidden'); forgotBox.classList.add('hidden'); };
showSignUp.onclick = ()=>{ signInBox.classList.add('hidden'); signUpBox.classList.remove('hidden'); forgotBox.classList.add('hidden'); };
$('showSignInFromUp').onclick = ()=> showSignIn.click();
$('backToSignIn').onclick = ()=> showSignIn.click();
$('toForgot').onclick = ()=>{ signInBox.classList.add('hidden'); signUpBox.classList.add('hidden'); forgotBox.classList.remove('hidden'); };

/* ----------------- Auth actions ----------------- */
/* SIGN UP (no email verification) */
signUpBtnEl.onclick = async ()=>{
  suMsg.textContent = 'Creating account...';
  const name = (suName.value||'').trim();
  const username = (suUsername.value||'').trim();
  const email = (suEmail.value||'').trim();
  const pw = suPass.value || '';
  const pw2 = suPass2.value || '';
  if(!name || !username || !email || !pw){ suMsg.textContent = 'All fields required.'; return; }
  if(pw !== pw2){ suMsg.textContent = 'Passwords do not match.'; return; }
  try{
    const cred = await createUserWithEmailAndPassword(auth, email, pw);
    // create user doc
    await setDoc(doc(db,'users',cred.user.uid), {
      fullName: name,
      username,
      email,
      createdAt: serverTimestamp(),
      balance: 0,
      bank: { bankName:'', acctName:'', acctNo:'' },
      firstTradePaid: false
    }, { merge:true });
    suMsg.textContent = 'Account created. You are signed in.';
  }catch(e){
    suMsg.textContent = e.message || e.code;
  }
};

/* SIGN IN */
signInBtnEl.onclick = async ()=>{
  siMsg.textContent = 'Signing in...';
  try{
    await signInWithEmailAndPassword(auth, siEmail.value.trim(), siPass.value);
    siMsg.textContent = '';
  }catch(e){
    siMsg.textContent = e.message || e.code;
  }
};

/* FORGOT */
forgotBtnEl.onclick = async ()=>{
  const em = (fgEmail.value||'').trim();
  if(!em){ fgMsg.textContent = 'Enter your email.'; return; }
  try{
    await sendPasswordResetEmail(auth, em);
    fgMsg.textContent = 'Reset link sent to ' + em;
  }catch(e){ fgMsg.textContent = e.message || e.code; }
};

/* LOGOUT */
logoutBtn.onclick = ()=> signOut(auth);

/* ----------------- Load public admin data from Firestore ----------------- */
async function loadPublicData(){
  try{
    const r = await getDoc(doc(db,'rates','default'));
    if(r.exists()){
      const d = r.data();
      usdToNgn = Number(d.usdToNgn||0);
      // show usd rate if needed
    }
  }catch(e){}
  // wallets
  try{
    const w = await getDoc(doc(db,'wallets','default'));
    if(w.exists()){
      const d = w.data();
      btcAddress = d?.btc?.address || '';
      usdtNetworks = (d?.usdt?.networks||[]);
      usdtNet.innerHTML = '<option value="">â€”</option>' + usdtNetworks.map(n=>`<option value="${n.network}">${n.network}</option>`).join('');
    }
  }catch(e){}
  // announcements
  try{
    const a = await getDoc(doc(db,'announcements','default'));
    if(a.exists()){
      $('annList').innerHTML = '';
      (a.data().items||[]).forEach(t=>{
        const span = document.createElement('span'); span.className='chip'; span.textContent = t;
        $('annList').appendChild(span);
      });
    }
  }catch(e){}
  // giftcardRates
  try{
    const gr = await getDoc(doc(db,'giftcardRates','default'));
    giftRates = gr.exists() ? (gr.data().brands||{}) : {};
  }catch(e){ giftRates = {}; }
  // walletRates
  try{
    const wr = await getDoc(doc(db,'walletRates','default'));
    walletRateMap = wr.exists() ? (wr.data().types||{}) : {};
  }catch(e){ walletRateMap = {}; }
  // processingTimes
  try{
    const pt = await getDoc(doc(db,'processingTimes','default'));
    procTimeMap = pt.exists() ? (pt.data()||{}) : {};
  }catch(e){ procTimeMap = {}; }

  renderRateBoxes();
  fillFormSelects();
  updateGiftEstimate();
  updateOwEstimate();
  refreshCryptoAddress();
}

/* render gift & wallet rate summaries (compact) */
function renderRateBoxes(){
  const giftRatesBox = $('giftRates'), walletRatesBox = $('walletRates');
  if(giftRatesBox) giftRatesBox.innerHTML='';
  if(walletRatesBox) walletRatesBox.innerHTML='';
  // (we mainly fill selects; these boxes are optional)
}

/* fill selects for gift brands / countries / wallet types */
function fillFormSelects(){
  const brands = Object.keys(giftRates||{});
  giftBrand.innerHTML = brands.length ? brands.map(b=>`<option value="${b}">${b}</option>`).join('') : '<option value="">â€”</option>';
  const b = giftBrand.value;
  const gc = (giftRates[b]?.countries) || {};
  giftCountry.innerHTML = Object.keys(gc).length ? Object.keys(gc).map(c=>`<option value="${c}">${c}</option>`).join('') : '<option value="">â€”</option>';

  const wtypes = Object.keys(walletRateMap||{});
  owType.innerHTML = wtypes.length ? wtypes.map(t=>`<option value="${t}">${t}</option>`).join('') : '<option value="">â€”</option>';
  const t = owType.value;
  const wc = (walletRateMap[t]?.countries) || {};
  owCountry.innerHTML = Object.keys(wc).length ? Object.keys(wc).map(c=>`<option value="${c}">${c}</option>`).join('') : '<option value="">â€”</option>';
}

/* estimate calculations */
function updateGiftEstimate(){
  const brand = giftBrand.value, country = giftCountry.value;
  const amt = Number(giftAmount.value||0);
  const rate = giftRates[brand]?.countries?.[country] || 0;
  const est = Math.max(0, amt * rate);
  giftEstimate.value = currency(est);
}
function updateOwEstimate(){
  const type = owType.value, country = owCountry.value;
  const amt = Number(owAmount.value||0);
  const rate = walletRateMap[type]?.countries?.[country] || 0;
  const est = Math.max(0, amt * rate);
  owEstimate.value = currency(est);
}

/* events for selects */
giftBrand.onchange = ()=> { fillFormSelects(); updateGiftEstimate(); };
giftCountry.onchange = updateGiftEstimate; giftAmount.oninput = updateGiftEstimate;
owType.onchange = ()=> { fillFormSelects(); updateOwEstimate(); };
owCountry.onchange = updateOwEstimate; owAmount.oninput = updateOwEstimate;

/* crypto UI */
function refreshCryptoAddress(){
  if(cryptoType.value === 'BTC'){
    cryptoAddress.value = btcAddress||'';
    renderQR(qrBox, btcAddress||'');
    usdtNet.value = ''; usdtNet.disabled = true;
  }else{
    usdtNet.disabled = false;
    const sel = usdtNetworks.find(n=>n.network===usdtNet.value) || usdtNetworks[0];
    const addr = sel?.address || '';
    cryptoAddress.value = addr;
    renderQR(qrBox, addr);
  }
}
cryptoType.onchange = refreshCryptoAddress; usdtNet.onchange = refreshCryptoAddress;

/* copy helpers */
copyAddr.onclick = async ()=>{
  if(!cryptoAddress.value) return;
  try{ await navigator.clipboard.writeText(cryptoAddress.value); copyAddr.textContent='Copied âœ“'; setTimeout(()=>copyAddr.textContent='Copy address',900); }catch(e){}
};

/* upload helper */
async function uploadImagesReturnUrls(files, folder){
  const list = Array.from(files||[]).slice(0,5);
  const urls = [];
  for(const f of list){
    const r = sRef(storage, `${folder}/${Date.now()}_${Math.random().toString(36).slice(2)}_${f.name}`);
    await uploadBytes(r, f);
    urls.push(await getDownloadURL(r));
  }
  return urls;
}

/* Submit gift */
submitGift.onclick = async ()=>{
  if(!giftBrand.value || !giftCountry.value || !giftAmount.value){ giftMsg.textContent='Fill brand, country and amount.'; return; }
  giftMsg.textContent = 'Uploading...';
  try{
    const urls = await uploadImagesReturnUrls(giftFiles.files, `trades/${currentUser.uid}`);
    const rate = giftRates[giftBrand.value]?.countries?.[giftCountry.value] || 0;
    const est = Math.max(0, Number(giftAmount.value||0) * rate);
    await addDoc(collection(db,'trades'),{
      uid: currentUser.uid, type: 'gift',
      brand: giftBrand.value, country: giftCountry.value,
      amountUsd: Number(giftAmount.value||0), estimatedNgn: est,
      images: urls, status: 'pending', createdAt: serverTimestamp()
    });
    giftMsg.textContent = 'Submitted âœ“ Weâ€™ll review and pay to your bank.';
    setTimeout(()=>giftMsg.textContent='',2200);
    giftFiles.value=''; giftAmount.value=''; updateGiftEstimate();
  }catch(e){ giftMsg.textContent = e.message || e.code; }
};

/* Mark crypto sent */
markCryptoSent.onclick = async ()=>{
  cryptoMsg.textContent = 'Submitting...';
  try{
    const isBtc = cryptoType.value === 'BTC';
    const addr = isBtc ? (btcAddress||'') : (usdtNetworks.find(n=>n.network===usdtNet.value)?.address||'');
    await addDoc(collection(db,'trades'),{
      uid: currentUser.uid, type: isBtc ? 'btc' : 'usdt',
      network: isBtc ? '' : (usdtNet.value||''), address: addr,
      amountCrypto: Number(cryptoAmount.value||0), status:'pending', createdAt: serverTimestamp()
    });
    cryptoMsg.textContent = 'Marked âœ“ Weâ€™ll confirm and pay to your bank.';
    setTimeout(()=>cryptoMsg.textContent='',2000); cryptoAmount.value='';
  }catch(e){ cryptoMsg.textContent = e.message || e.code; }
};

/* Submit online wallet */
submitOW.onclick = async ()=>{
  if(!owType.value || !owCountry.value || !owAmount.value){ owMsg.textContent='Fill wallet, country, and amount.'; return; }
  owMsg.textContent = 'Submitting...';
  try{
    const rate = walletRateMap[owType.value]?.countries?.[owCountry.value] || 0;
    const est = Math.max(0, Number(owAmount.value||0) * rate);
    await addDoc(collection(db,'trades'),{
      uid: currentUser.uid, type:'wallet', walletType: owType.value, country: owCountry.value,
      amountUsd: Number(owAmount.value||0), estimatedNgn: est, status:'pending', createdAt: serverTimestamp()
    });
    owMsg.textContent = 'Submitted âœ“ Please message admin for tag if needed.';
    setTimeout(()=>owMsg.textContent='',2200); owAmount.value=''; updateOwEstimate();
  }catch(e){ owMsg.textContent = e.message || e.code; }
};

/* Withdraw request */
reqWithdraw.onclick = async ()=>{
  wdMsg.textContent = 'Requesting...';
  const amt = Number(wdAmount.value||0);
  const avail = Number((wdAvail.value||'').replace(/[â‚¦,]/g,'')||0);
  if(amt<=0){ wdMsg.textContent='Enter a valid amount.'; return; }
  if(amt>avail){ wdMsg.textContent='Amount exceeds available balance.'; return; }
  try{
    await addDoc(collection(db,'withdrawals'),{ uid: currentUser.uid, amount: amt,
      bank: { bankName: $('bankName')?.value || '', acctName: $('acctName')?.value || '', acctNo: $('acctNo')?.value || '' },
      status:'pending', createdAt: serverTimestamp() });
    wdMsg.textContent = 'Withdraw request sent âœ“';
    setTimeout(()=>wdMsg.textContent='',1800); wdAmount.value='';
  }catch(e){ wdMsg.textContent = e.message || e.code; }
};

/* Watch user data & history */
function watchUserData(uid){
  onSnapshot(doc(db,'users',uid), snap=>{
    const d = snap.data() || {};
    const bal = Number(d.balance||0);
    balNgn.textContent = currency(bal);
    wdAvail.value = currency(bal);
    userNameDisplay.textContent = d.fullName || d.username || d.email || 'User';
    // show profile link
    NAV.profileLink.classList.remove('hidden');
    $('logoutBtn').classList.remove('hidden');
  });

  const qTrades = query(collection(db,'trades'), where('uid','==',uid), orderBy('createdAt','desc'));
  onSnapshot(qTrades, qs=>{
    historyBox.innerHTML = '';
    qs.forEach(docu=>{
      const t = docu.data();
      const item = document.createElement('div'); item.className='row';
      const top = document.createElement('div'); top.className='flex';
      const tag = document.createElement('span'); tag.className='chip'; tag.textContent = (t.type||'').toUpperCase();
      const st = document.createElement('span'); st.className='chip'; st.textContent = t.status || 'pending';
      top.append(tag, st);
      const mid = document.createElement('div'); mid.className='muted';
      mid.textContent = JSON.stringify({
        brand:t.brand, country:t.country, wallet:t.walletType, network:t.network,
        amountUsd:t.amountUsd, amountCrypto:t.amountCrypto, estimatedNgn:t.estimatedNgn
      });
      item.appendChild(top); item.appendChild(mid);
      historyBox.appendChild(item);
    });
  });

  const qW = query(collection(db,'withdrawals'), where('uid','==',uid), orderBy('createdAt','desc'));
  onSnapshot(qW, qs=>{
    if(!qs.empty){
      const title = document.createElement('div'); title.innerHTML = '<div class="divider"></div><h4>Your withdrawals</h4>';
      historyBox.appendChild(title);
      qs.forEach(docu=>{
        const w = docu.data();
        const item = document.createElement('div'); item.className='row';
        const top = document.createElement('div'); top.className='flex';
        const tag = document.createElement('span'); tag.className='chip'; tag.textContent = 'WITHDRAW';
        const st = document.createElement('span'); st.className='chip'; st.textContent = w.status || 'pending';
        const amt = document.createElement('span'); amt.className='chip'; amt.textContent = currency(w.amount);
        top.append(tag, st, amt);
        item.appendChild(top);
        historyBox.appendChild(item);
      });
    }
  });
}

/* Referral link display helper */
function setRefLink(uid){
  const url = new URL(location.href);
  url.search = '';
  const link = url.origin + url.pathname + '?ref=' + uid;
  const refEl = $('refLink'); if(refEl) refEl.textContent = link;
}

/* Toggle history visibility */
btnToggleHistory.onclick = ()=> historyWrap.classList.toggle('hidden');

/* ----------------- Auth state handling + splash hardcap ----------------- */
let authResolved = false;
setTimeout(()=>{ if(!authResolved){ authView.classList.remove('hidden'); dashView.classList.add('hidden'); hideSplashNow(); } }, 2500);

onAuthStateChanged(auth, async user=>{
  authResolved = true;
  if(!user){
    currentUser = null;
    authView.classList.remove('hidden');
    dashView.classList.add('hidden');
    NAV.profileLink.classList.add('hidden');
    $('logoutBtn').classList.add('hidden');
    hideSplashNow();
    return;
  }
  currentUser = user;
  try {
    const uref = doc(db,'users',user.uid);
    const udoc = await getDoc(uref);
    if(!udoc.exists()){
      await setDoc(uref, { email:user.email, createdAt:serverTimestamp(), balance:0, bank:{}, firstTradePaid:false }, { merge:true });
    }
    setRefLink(user.uid);
    await loadPublicData();
    watchUserData(user.uid);
    // show dashboard
    authView.classList.add('hidden');
    dashView.classList.remove('hidden');
    // show gift view by default
    clearViews(); $('view-gift').classList.remove('hidden'); NAV.trades.classList.add('active');
  } catch(e){
    // fallback: show auth
    authView.classList.remove('hidden'); dashView.classList.add('hidden');
  } finally {
    hideSplashNow();
  }
});

/* ensure nav/profile visibility toggling on logout too */
signOut(auth).catch(()=>{}); // no-op - not forcing signout

/* Hide splash after a max of 6s if something odd happens */
setTimeout(()=>{ hideSplashNow(); }, 6000);

</script>

<!-- Tawk widget - paste your widget script below (optional) -->
<!--
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;s1.src='https://embed.tawk.to/XXXXXXXX/default';s1.charset='UTF-8';s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);})();
</script>
-->

</body>
</html>
