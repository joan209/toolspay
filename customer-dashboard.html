<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Toolspay ‚Äî Customer Dashboard</title>
<link rel="stylesheet" href="style.css"/>

<style>
  :root{
    --bg:#0b1220; --fg:#e5e7eb; --card:#0f172a; --muted:#94a3b8; --accent:#ffd700; --line:#1f2937;
  }
  [data-theme="light"]{
    --bg:#f7f7f8; --fg:#111827; --card:#ffffff; --muted:#6b7280; --accent:#b8860b; --line:#e5e7eb;
  }
  html,body{height:100%;}
  body{margin:0; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--fg);}
  .container{max-width:1000px; margin:0 auto; padding:16px;}
  .header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; border-bottom:1px solid var(--line); position:sticky; top:0; background:var(--bg); z-index:3;}
  .tp-logo{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#111,var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;}
  .muted{color:var(--muted); font-size:12px;}
  .grid{display:grid; gap:12px;}
  @media(min-width:780px){ .grid-2{grid-template-columns:1fr 1fr;} .grid-3{grid-template-columns:1fr 1fr 1fr;} }
  .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px;}
  .card h3{margin:0 0 8px 0;}
  input,select,textarea,button{width:100%; background:transparent; color:var(--fg); border:1px solid var(--line); border-radius:10px; padding:10px;}
  textarea{resize:vertical;}
  button{cursor:pointer;}
  .btn{border:0; background:#000; color:var(--accent); border:2px solid var(--accent);}
  .btn-ghost{background:transparent; border:1px solid var(--line); color:var(--fg);}
  .row{display:flex; gap:8px; flex-wrap:wrap;}
  .pill{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px;}
  .tag{font-size:12px; padding:6px 8px; border:1px dashed var(--line); border-radius:8px;}
  .kbd{font-family:ui-monospace, Menlo, Consolas, monospace; background:rgba(255,255,255,0.06); padding:2px 6px; border-radius:6px;}
  .right{display:flex; align-items:center; gap:8px;}
  .hide{display:none;}
  .money{font-weight:800;}
  .list{display:flex; gap:10px; flex-direction:column;}
  .hr{height:1px; background:var(--line); margin:8px 0;}
  .center{display:flex; align-items:center; justify-content:center;}
  .copy{cursor:pointer; border:1px dashed var(--line); padding:6px 10px; border-radius:8px; font-size:12px;}

  /* splash */
  #splash{position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center; z-index:9999;}
  #splash .tp{width:88px;height:88px;border-radius:20px; background:linear-gradient(135deg,#111,var(--accent)); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:28px; box-shadow:0 10px 30px rgba(0,0,0,.35);}
</style>
</head>

<body data-theme="dark">
  <!-- Splash -->
  <div id="splash"><div class="tp">TP</div></div>

  <header class="header">
    <div class="row" style="align-items:center">
      <div class="tp-logo">TP</div>
      <div>
        <div style="font-weight:800">Toolspay ‚Äî Customer</div>
        <div class="muted">Trade gift cards / crypto & get paid in NGN</div>
      </div>
    </div>
    <div class="right">
      <button id="themeBtn" class="btn-ghost" style="width:auto; padding:8px 12px;">üåô/‚òÄÔ∏è</button>
      <button id="logoutBtn" class="btn-ghost" style="width:auto; padding:8px 12px;">Sign out</button>
    </div>
  </header>

  <main class="container">
    <!-- AUTH GATE (shows if not signed in) -->
    <section id="authGate" class="card hide">
      <h3>Sign in to continue</h3>
      <div class="grid grid-2">
        <div><input id="authEmail" type="email" placeholder="you@email.com"/></div>
        <div><input id="authPass" type="password" placeholder="Password"/></div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="resetBtn" class="btn-ghost">Send reset link</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:6px;"></div>
    </section>

    <!-- DASHBOARD -->
    <section id="dash" class="hide">
      <div class="grid grid-3">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <h3>Rates</h3>
            <span class="muted">Live</span>
          </div>
          <div class="hr"></div>
          <div class="list" id="ratesBox">
            <div>USD ‚Üí NGN: <span id="usdToNgn" class="money">‚Äî</span></div>
            <div>Gift card base: <span id="gcBase" class="money">‚Äî</span> ‚Ç¶/$</div>
          </div>
        </div>

        <div class="card">
          <h3>Announcements</h3>
          <div class="hr"></div>
          <ul id="annList" class="list" style="list-style:disc; padding-left:20px;"></ul>
        </div>

        <div class="card">
          <h3>Your balance</h3>
          <div class="hr"></div>
          <div>Available: <span id="balNgn" class="money">‚Ç¶0</span></div>
          <div class="muted">Manual payouts by admin after trade confirmation.</div>
        </div>
      </div>

      <!-- Gift card trading -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;">
          <h3>Sell Gift Card</h3>
          <span class="muted">Upload card & receipt (optional multiple)</span>
        </div>
        <div class="grid grid-3">
          <div>
            <label>Brand</label>
            <select id="gcBrand"></select>
          </div>
          <div>
            <label>Country</label>
            <select id="gcCountry"></select>
          </div>
          <div>
            <label>Face value (USD)</label>
            <input id="gcAmount" type="number" min="1" placeholder="e.g. 100"/>
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="pill">Estimated payout: <span id="gcEstimate" class="money">‚Ç¶0</span></div>
          <div class="muted">Auto-updates using your per-brand/per-country rate, else base.</div>
        </div>

        <div class="grid grid-2" style="margin-top:8px;">
          <div>
            <label>Upload card front/back + receipt (you can select many)</label>
            <input id="gcFiles" type="file" accept="image/*" multiple/>
          </div>
          <div>
            <label>Notes (optional)</label>
            <textarea id="gcNotes" rows="3" placeholder="Any info for admin‚Ä¶"></textarea>
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="gcSubmit" class="btn">Submit gift card</button>
          <span id="gcMsg" class="muted"></span>
        </div>
      </div>

      <!-- Crypto selling -->
      <div class="grid grid-2">
        <div class="card">
          <h3>Sell BTC</h3>
          <div id="btcAddrBox" class="row" style="align-items:center; justify-content:space-between; margin:6px 0;">
            <div id="btcAddressText" class="kbd">‚Äî</div>
            <div class="copy" id="copyBtc">Copy</div>
          </div>
          <div class="center" style="margin:10px 0;">
            <img id="btcQr" alt="BTC QR" width="180" height="180"/>
          </div>
          <div class="muted">Send BTC here, then admin confirms and pays you in NGN.</div>
        </div>

        <div class="card">
          <h3>Sell USDT</h3>
          <div class="row"><select id="usdtNet"></select></div>
          <div id="usdtAddrBox" class="row" style="align-items:center; justify-content:space-between; margin:6px 0;">
            <div id="usdtAddressText" class="kbd">‚Äî</div>
            <div class="copy" id="copyUsdt">Copy</div>
          </div>
          <div class="center" style="margin:10px 0;">
            <img id="usdtQr" alt="USDT QR" width="180" height="180"/>
          </div>
          <div class="muted">Pick network, send USDT, then admin confirms and pays you in NGN.</div>
        </div>
      </div>

      <!-- Online wallet section (users must chat admin to get tag) -->
      <div class="card">
        <h3>Online Wallets</h3>
        <div class="muted">Choose a wallet, then click ‚ÄúChat admin for tag‚Äù to request the tag. Rates shown are set by admin.</div>
        <div id="owList" class="list" style="margin-top:8px;"></div>
        <div class="row"><a href="#tawkchat" id="chatAdminBtn" class="btn" style="text-align:center; text-decoration:none;">Chat admin for tag</a></div>
      </div>

      <!-- Profile / bank -->
      <div class="grid grid-2">
        <div class="card">
          <h3>Your Bank Details</h3>
          <div class="grid grid-2">
            <div><input id="bankName" placeholder="Bank name"/></div>
            <div><input id="bankAcctName" placeholder="Account name"/></div>
            <div><input id="bankAcctNo" placeholder="Account number"/></div>
          </div>
          <div class="row" style="margin-top:8px;">
            <button id="saveBank" class="btn-ghost">Save</button><span id="bankMsg" class="muted"></span>
          </div>
        </div>

        <div class="card">
          <h3>Withdraw</h3>
          <div class="muted">Request payout from your available balance.</div>
          <div class="grid grid-2" style="margin-top:6px;">
            <div><input id="wdAmount" type="number" min="1" placeholder="Amount (‚Ç¶)"/></div>
            <div><button id="wdBtn" class="btn">Request withdrawal</button></div>
          </div>
          <div id="wdMsg" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>

      <!-- History -->
      <div class="card">
        <h3>History</h3>
        <div class="muted">Trades & withdrawals</div>
        <div id="history" class="list" style="margin-top:8px;"></div>
      </div>

      <!-- Referrals -->
      <div class="card">
        <h3>Refer & Earn</h3>
        <div class="muted">Share your link. You earn <b>‚Ç¶1000</b> when your friend completes their first trade.</div>
        <div class="row" style="margin-top:8px;">
          <div id="refLink" class="kbd" style="flex:1;">‚Äî</div>
          <div id="copyRef" class="copy">Copy link</div>
        </div>
        <div id="refMsg" class="muted" style="margin-top:6px;"></div>
      </div>
    </section>
  </main>

  <!-- Firebase + App -->
  <script type="module">
    // --- Firebase SDKs ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, sendPasswordResetEmail, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, collection, query, where, getDocs, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import {
      getStorage, ref as sref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    // --- YOUR CONFIG (inserted as requested) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-BIOpzkQBtpW1LQk7Rf3c-ZvyIbvEc7c",
      authDomain: "toolspay-54167.firebaseapp.com",
      projectId: "toolspay-54167",
      storageBucket: "toolspay-54167.firebasestorage.app",
      messagingSenderId: "71318117342",
      appId: "1:71318117342:web:1952711453e19e19281b4f"
    };

    // --- Init ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    // --- UI refs ---
    const splash   = document.getElementById('splash');
    const dash     = document.getElementById('dash');
    const authGate = document.getElementById('authGate');
    const themeBtn = document.getElementById('themeBtn');
    const logoutBtn= document.getElementById('logoutBtn');

    const authEmail= document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const loginBtn = document.getElementById('loginBtn');
    const resetBtn = document.getElementById('resetBtn');
    const authMsg  = document.getElementById('authMsg');

    const usdToNgnEl = document.getElementById('usdToNgn');
    const gcBaseEl   = document.getElementById('gcBase');

    const annList = document.getElementById('annList');

    const gcBrand   = document.getElementById('gcBrand');
    const gcCountry = document.getElementById('gcCountry');
    const gcAmount  = document.getElementById('gcAmount');
    const gcEstimate= document.getElementById('gcEstimate');
    const gcFiles   = document.getElementById('gcFiles');
    const gcNotes   = document.getElementById('gcNotes');
    const gcSubmit  = document.getElementById('gcSubmit');
    const gcMsg     = document.getElementById('gcMsg');

    const btcAddressText = document.getElementById('btcAddressText');
    const btcQr = document.getElementById('btcQr');
    const copyBtc = document.getElementById('copyBtc');

    const usdtNet = document.getElementById('usdtNet');
    const usdtAddressText = document.getElementById('usdtAddressText');
    const usdtQr = document.getElementById('usdtQr');
    const copyUsdt = document.getElementById('copyUsdt');

    const owList = document.getElementById('owList');
    const chatAdminBtn = document.getElementById('chatAdminBtn');

    const bankName = document.getElementById('bankName');
    const bankAcctName = document.getElementById('bankAcctName');
    const bankAcctNo = document.getElementById('bankAcctNo');
    const saveBank = document.getElementById('saveBank');
    const bankMsg  = document.getElementById('bankMsg');

    const balNgn = document.getElementById('balNgn');
    const history = document.getElementById('history');

    const wdAmount = document.getElementById('wdAmount');
    const wdBtn = document.getElementById('wdBtn');
    const wdMsg = document.getElementById('wdMsg');

    const refLink = document.getElementById('refLink');
    const copyRef = document.getElementById('copyRef');
    const refMsg  = document.getElementById('refMsg');

    // --- Theme + Splash ---
    themeBtn.onclick = () => {
      const cur = document.body.getAttribute('data-theme');
      document.body.setAttribute('data-theme', cur === 'dark' ? 'light' : 'dark');
      localStorage.setItem('tp-theme', document.body.getAttribute('data-theme'));
    };
    const savedTheme = localStorage.getItem('tp-theme');
    if (savedTheme) document.body.setAttribute('data-theme', savedTheme);

    // splash 2.2s
    setTimeout(()=> splash.classList.add('hide'), 2200);

    // --- Helpers ---
    const nf = new Intl.NumberFormat('en-NG');
    const money = n => '‚Ç¶' + nf.format(Math.max(0, Math.round(n||0)));

    function qrUrl(data){
      return 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=' + encodeURIComponent(data||'');
    }

    function estimateGiftCard(brand, country, amount, base, map){
      const per = (map?.[brand]?.countries?.[country]) ?? base;
      const a = Number(amount||0);
      return a * Number(per||0);
    }

    async function ensureUserDoc(user){
      const uref = doc(db, 'users', user.uid);
      const snap = await getDoc(uref);
      if (!snap.exists()){
        // referral tracking
        const urlParams = new URLSearchParams(window.location.search);
        const referredBy = urlParams.get('ref') || null;
        const code = user.uid.slice(0,6).toUpperCase(); // simple code
        await setDoc(uref, {
          email: user.email,
          createdAt: serverTimestamp(),
          bank: {},
          balanceNgn: 0,
          bonusNgn: 0,
          referralCode: code,
          referredBy,
          referralCredited: false
        }, { merge:true });
      }
      return uref;
    }

    // --- Auth UI ---
    loginBtn.onclick = async ()=>{
      authMsg.textContent = 'Signing in...';
      try{
        await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPass.value);
        authMsg.textContent = '';
      }catch(e){
        authMsg.textContent = e.message || e.code;
      }
    };
    resetBtn.onclick = async ()=>{
      const em = (authEmail.value||'').trim();
      if(!em){ authMsg.textContent='Enter email first'; return; }
      try{
        await sendPasswordResetEmail(auth, em);
        authMsg.textContent = 'Reset link sent.';
      }catch(e){
        authMsg.textContent = e.message || e.code;
      }
    };
    logoutBtn.onclick = ()=> signOut(auth);

    // --- Live state ---
    let GC_RATES = {}; // giftcardRates map
    let USD_NGN = 0;
    let GC_BASE = 0;
    let WALLETS = null;
    let USER = null;

    function bindGiftCardSelectors(){
      // Preload brands and countries from GC_RATES (fallback to defaults)
      const brands = Object.keys(GC_RATES).length
        ? Object.keys(GC_RATES)
        : ["Amazon","Apple / iTunes","Steam","Google Play","Walmart","Razer Gold","Visa","Amex","eBay","Target"];
      gcBrand.innerHTML = brands.map(b=>`<option value="${b}">${b}</option>`).join('');

      const defaultCountries = ["USA","UK","Canada","Australia","Eurozone","Switzerland","UAE","Turkey","Ghana","Kenya","South Africa","Nigeria"];
      const countries = new Set(defaultCountries);
      // merge any from map
      Object.values(GC_RATES).forEach(v=>{
        if (v?.countries) Object.keys(v.countries).forEach(c=>countries.add(c));
      });
      gcCountry.innerHTML = Array.from(countries).map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    function updateGcEstimate(){
      const est = estimateGiftCard(gcBrand.value, gcCountry.value, gcAmount.value, GC_BASE, GC_RATES);
      gcEstimate.textContent = money(est);
    }

    function renderWallets(){
      // BTC
      const btc = WALLETS?.btc?.address || '';
      btcAddressText.textContent = btc || '‚Äî';
      btcQr.src = qrUrl(btc || 'none');

      // USDT
      const nets = WALLETS?.usdt?.networks || [];
      usdtNet.innerHTML = nets.map(n=>`<option value="${n.network}">${n.network}</option>`).join('');
      const setUsdt = ()=>{
        const sel = nets.find(n=>n.network === usdtNet.value);
        const addr = sel?.address || '';
        usdtAddressText.textContent = addr || '‚Äî';
        usdtQr.src = qrUrl(addr || 'none');
      };
      usdtNet.onchange = setUsdt;
      setUsdt();

      // Online wallets (with per-type rates if admin added them under wallets.tags + wallets.rates)
      const tags = WALLETS?.tags || {};
      const owRates = WALLETS?.owRates || {}; // e.g. { chime: 1450, zelle: 1400, ... }
      const items = [
        {key:'chime', label:'Chime'},
        {key:'zelle', label:'Zelle'},
        {key:'venmo', label:'Venmo'},
        {key:'paypal', label:'PayPal'}
      ];
      owList.innerHTML = items.map(it=>{
        const rate = owRates[it.key] ?? GC_BASE;
        return `
          <div class="row" style="align-items:center; justify-content:space-between;">
            <div class="row" style="align-items:center;">
              <span class="pill">${it.label}</span>
              <span class="muted">Rate: <b>${rate}</b> ‚Ç¶/$</span>
            </div>
            <div class="tag">Ask admin for ${it.label} tag in chat ‚Üí</div>
          </div>`;
      }).join('');
    }

    function copy(text){
      navigator.clipboard.writeText(text||'');
    }
    copyBtc.onclick = ()=> copy(btcAddressText.textContent);
    copyUsdt.onclick = ()=> copy(usdtAddressText.textContent);

    function renderAnnouncements(items){
      annList.innerHTML = (items||[]).map(x=>`<li>${x}</li>`).join('');
    }

    async function loadRatesAndWallets(){
      const r = await getDoc(doc(db,'rates','default'));
      if (r.exists()){
        const d = r.data();
        USD_NGN = Number(d.usdToNgn||0);
        GC_BASE = Number(d.giftcardBase||0);
        usdToNgnEl.textContent = money(USD_NGN);
        gcBaseEl.textContent = GC_BASE;
      }

      const w = await getDoc(doc(db,'wallets','default'));
      if (w.exists()){
        WALLETS = w.data();
        renderWallets();
      }

      // Gift card per-brand per-country map
      // collection: giftcardRates, docs per brand: { countries: { "USA": 750, ... } }
      const qSnap = await getDocs(collection(db, 'giftcardRates'));
      GC_RATES = {};
      qSnap.forEach(docSnap=>{
        GC_RATES[docSnap.id] = docSnap.data() || {};
      });
      bindGiftCardSelectors();
      updateGcEstimate();
    }

    // announcements live
    onSnapshot(doc(db,'announcements','default'),(snap)=>{
      if (snap.exists()){
        const items = Array.isArray(snap.data().items) ? snap.data().items : [];
        renderAnnouncements(items);
      } else {
        renderAnnouncements([]);
      }
    });

    // Profile / bank save
    saveBank.onclick = async ()=>{
      if (!USER) return;
      bankMsg.textContent = 'Saving...';
      try{
        await setDoc(doc(db,'users',USER.uid), {
          bank:{
            bankName: (bankName.value||'').trim(),
            acctName: (bankAcctName.value||'').trim(),
            acctNo:   (bankAcctNo.value||'').trim()
          }
        }, { merge:true });
        bankMsg.textContent = 'Saved ‚úì';
        setTimeout(()=>bankMsg.textContent='',1200);
      }catch(e){
        bankMsg.textContent = e.message || e.code;
      }
    };

    // Withdraw
    wdBtn.onclick = async ()=>{
      wdMsg.textContent = 'Submitting...';
      try{
        const amt = Number(wdAmount.value||0);
        if (!amt || amt<=0){ wdMsg.textContent='Enter amount'; return; }
        await addDoc(collection(db,'withdrawals'),{
          uid: USER.uid,
          amount: amt,
          createdAt: serverTimestamp(),
          status: 'pending'
        });
        wdMsg.textContent = 'Withdrawal requested ‚úì';
        setTimeout(()=>wdMsg.textContent='',1500);
        wdAmount.value = '';
      }catch(e){
        wdMsg.textContent = e.message || e.code;
      }
    };

    // Gift card submit (multi-upload)
    gcSubmit.onclick = async ()=>{
      if (!USER){ gcMsg.textContent='Sign in first.'; return; }
      gcMsg.textContent = 'Uploading...';

      try{
        // upload files
        const urls = [];
        const files = Array.from(gcFiles.files||[]);
        for (let i=0;i<files.length;i++){
          const f = files[i];
          const path = `giftcards/${USER.uid}/${Date.now()}_${i}_${f.name}`;
          const r = sref(st, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          urls.push(url);
        }

        const payoutNgn = estimateGiftCard(gcBrand.value, gcCountry.value, gcAmount.value, GC_BASE, GC_RATES);

        await addDoc(collection(db,'trades'),{
          uid: USER.uid,
          type: 'giftcard',
          brand: gcBrand.value,
          country: gcCountry.value,
          amountUsd: Number(gcAmount.value||0),
          estPayoutNgn: Math.round(payoutNgn||0),
          note: (gcNotes.value||'').trim(),
          images: urls,
          status: 'submitted',
          createdAt: serverTimestamp()
        });

        gcMsg.textContent = 'Submitted ‚úì Admin will review and pay to your bank.';
        gcFiles.value = ''; gcNotes.value=''; gcAmount.value='';
        updateGcEstimate();
      }catch(e){
        gcMsg.textContent = e.message || e.code;
      }
    };

    // Estimate updates
    gcBrand.onchange = updateGcEstimate;
    gcCountry.onchange = updateGcEstimate;
    gcAmount.oninput = updateGcEstimate;

    // History + balances
    async function loadUserPanel(uid){
      // user doc
      const uref = doc(db, 'users', uid);
      onSnapshot(uref, (snap)=>{
        const d = snap.data() || {};
        const b = Number(d.balanceNgn||0) + Number(d.bonusNgn||0);
        balNgn.textContent = money(b);

        // prefill bank
        bankName.value = d?.bank?.bankName || '';
        bankAcctName.value = d?.bank?.acctName || '';
        bankAcctNo.value   = d?.bank?.acctNo || '';

        // referral link
        const code = d.referralCode || uid.slice(0,6).toUpperCase();
        const base = location.origin + location.pathname.replace(/customer-dashboard\.html$/,'customer-dashboard.html');
        const link = base + '?ref=' + encodeURIComponent(code);
        refLink.textContent = link;
        copyRef.onclick = ()=>{ navigator.clipboard.writeText(link); refMsg.textContent='Copied ‚úì'; setTimeout(()=>refMsg.textContent='',1000); };
      });

      // history list (trades + withdrawals)
      const render = async ()=>{
        const qs1 = await getDocs(query(collection(db,'trades'), where('uid','==',uid)));
        const qs2 = await getDocs(query(collection(db,'withdrawals'), where('uid','==',uid)));

        const items = [];
        qs1.forEach(d=>{
          const x=d.data();
          items.push({t:'Trade', s:x.status, a: '‚Ç¶'+nf.format(x.estPayoutNgn||0), when:x.createdAt?.toDate?.()?.toLocaleString?.()||''});
        });
        qs2.forEach(d=>{
          const x=d.data();
          items.push({t:'Withdrawal', s:x.status, a:'‚Ç¶'+nf.format(x.amount||0), when:x.createdAt?.toDate?.()?.toLocaleString?.()||''});
        });

        items.sort((a,b)=> (a.when<b.when?1:-1));
        history.innerHTML = items.length? items.map(i=>`
          <div class="row" style="justify-content:space-between;">
            <div>${i.t}</div><div class="muted">${i.when}</div><div>${i.a}</div><div class="pill">${i.s}</div>
          </div>`).join('') : '<div class="muted">No activity yet.</div>';
      };
      await render();
    }

    // Online wallet chat button (just focuses the tawk bubble)
    chatAdminBtn.onclick = (e)=>{
      e.preventDefault();
      try{ Tawk_API?.maximize?.(); }catch(_){}
    };

    // Auth state
    onAuthStateChanged(auth, async (user)=>{
      USER = user || null;
      if (!user){
        authGate.classList.remove('hide');
        dash.classList.add('hide');
        return;
      }
      authGate.classList.add('hide');
      dash.classList.remove('hide');

      await ensureUserDoc(user);
      await loadRatesAndWallets();
      await loadUserPanel(user.uid);
    });

    // Init load of public data (for signed out visitors viewing)
    loadRatesAndWallets();

  </script>

  <!-- Tawk.to (kept as you shared) -->
  <!-- Start of Tawk.to Script -->
  <script type="text/javascript">
  var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
  (function(){
    var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
    s1.async=true;
    s1.src='https://embed.tawk.to/689c8ac8fcd547192dde2522/1j2hns8ng';
    s1.charset='UTF-8';
    s1.setAttribute('crossorigin','*');
    s0.parentNode.insertBefore(s1,s0);
  })();
  </script>
  <!-- End of Tawk.to Script -->
</body>
            </html>
