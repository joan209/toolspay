<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Toolspay â€” Customer</title>
<meta name="color-scheme" content="light dark"/>
<style>
  :root{
    --bg: #f7f7f8; /* start light */
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --brand:#b58900;
    --ok:#059669;
    --danger:#b91c1c;
    --border:#e5e7eb;
    --chip:#f3f4f6;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e2e8f0;
      --muted:#94a3b8;
      --brand:#ffd700;
      --ok:#10b981;
      --danger:#ef4444;
      --border:#1f2937;
      --chip:#111827;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:1000px;margin:0 auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0}
  .row{display:grid;gap:10px}
  @media(min-width:720px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
  label{font-size:13px;font-weight:700;opacity:.9}
  input,select,textarea{width:100%;padding:11px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:15px}
  button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
  .btn{background:#111;color:var(--brand);border:2px solid var(--brand)}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn-muted{background:var(--chip);color:var(--text);border:1px solid var(--border)}
  .muted{color:var(--muted);font-size:13px}
  .header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .chip{padding:6px 10px;background:var(--chip);border:1px solid var(--border);border-radius:999px;font-size:13px}
  .money{font-weight:800}
  .brand-badge{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,#111,#ffd700);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900}
  .center{display:flex;align-items:center;justify-content:center}
  /* Splash */
  #splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;background:var(--bg);z-index:9999;transition:opacity .25s ease}
  #splash.hidden{opacity:0;pointer-events:none}
  #splash .tp{font-size:28px;font-weight:900;border:2px solid var(--brand);color:var(--brand);padding:10px 16px;border-radius:12px}
  .toolbar{position:sticky;top:0;background:var(--bg);z-index:9;border-bottom:1px solid var(--border)}
  .nav{display:flex;gap:8px;align-items:center}
  nav a{padding:8px 10px;border-radius:8px;text-decoration:none;color:var(--text);border:1px solid transparent;font-weight:700}
  nav a.active{border:1px solid var(--border);background:var(--card)}
  /* auth centered on mobile */
  #authView{max-width:520px;margin:10vh auto;padding:18px}
  @media(max-width:520px){
    #authView{margin:14vh 10px 8vh}
    #authView h2{font-size:22px}
    .row-2{grid-template-columns:1fr}
  }
  .error{color:var(--danger);font-weight:700}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash">
  <div class="tp">TP</div>
  <div class="muted">Loading dashboardâ€¦</div>
</div>

<header class="toolbar">
  <div class="container header">
    <div class="flex">
      <div class="brand-badge">TP</div>
      <div>
        <div style="font-weight:900;">Toolspay</div>
        <div class="muted">Sell Gift Cards â€¢ BTC â€¢ USDT â†’ Get paid in â‚¦</div>
      </div>
    </div>

    <div class="flex nav" id="topNav">
      <!-- nav links (controlled by hash routing) -->
      <a href="#/dashboard" id="navDash" class="active">Dashboard</a>
      <a href="#/profile" id="navProfile">Profile</a>
      <a href="#/history" id="navHistory">History</a>
      <a href="#/wallet" id="navWallet">Wallet</a>
      <div style="width:8px"></div>
      <button id="modeBtn" class="btn-ghost" title="Dark/Light" type="button">ðŸŒ“</button>
      <button id="openChatBtn" class="btn-ghost" title="Live chat" type="button">ðŸ’¬</button>
      <button id="logoutBtn" class="btn-ghost" type="button">Sign out</button>
    </div>
  </div>
</header>

<main class="container">

  <!-- AUTH VIEW (shown if not logged in) -->
  <section id="authView" class="card hidden" aria-live="polite">
    <h2 style="font-weight:900;margin:0 0 8px">Welcome to Toolspay</h2>
    <p class="muted">Create an account or sign in to start trading. Forgot-password will send reset email.</p>

    <div id="authError" class="error" style="margin-top:8px"></div>

    <!-- Signup form -->
    <div style="margin-top:12px">
      <label>Full name</label>
      <input id="nameInp" type="text" placeholder="Your full name"/>
    </div>
    <div style="margin-top:8px">
      <label>Username</label>
      <input id="unameInp" type="text" placeholder="username (no spaces)"/>
    </div>

    <div class="row row-2" style="margin-top:10px;">
      <div>
        <label>Email</label>
        <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email"/>
      </div>
      <div>
        <label>Password</label>
        <input id="authPass" type="password" placeholder="Password" autocomplete="new-password"/>
      </div>
    </div>

    <div style="margin-top:8px">
      <label>Confirm password</label>
      <input id="authPass2" type="password" placeholder="Confirm password" autocomplete="new-password"/>
    </div>

    <div class="row row-2" style="margin-top:12px;">
      <button id="signUpBtn" class="btn" type="button">Sign up</button>
      <button id="signInBtn" class="btn-ghost" type="button">Sign in</button>
    </div>

    <div style="margin-top:10px" class="flex">
      <button id="forgotBtn" class="btn-muted" type="button">Forgot password</button>
      <div style="flex:1"></div>
      <span id="authMsg" class="muted"></span>
    </div>
  </section>

  <!-- PROFILE SETUP (shown immediately after signup if missing profile fields) -->
  <section id="profileSetup" class="card hidden">
    <h3 style="margin:0 0 8px">Complete your profile</h3>
    <p class="muted">Please provide display name and username to continue.</p>
    <div style="margin-top:10px">
      <label>Full name</label>
      <input id="psName" placeholder="Full name"/>
    </div>
    <div style="margin-top:10px">
      <label>Username</label>
      <input id="psUname" placeholder="username"/>
    </div>
    <div style="margin-top:12px" class="flex">
      <button id="saveProfileBtn" class="btn">Save profile</button>
      <button id="skipProfileBtn" class="btn-ghost">Skip (you can edit later)</button>
      <span id="psMsg" class="muted"></span>
    </div>
  </section>

  <!-- DASHBOARD PAGE -->
  <section id="dashView" class="hidden">
    <!-- Stats -->
    <div class="row row-3">
      <div class="card">
        <div class="muted">Available balance</div>
        <div id="balNgn" class="money" style="font-size:22px">â‚¦0</div>
        <div class="muted">Withdraw to your bank after trades are paid.</div>
      </div>

      <div class="card">
        <div class="muted">Referral link</div>
        <div id="refLink" style="word-break:break-all"></div>
        <div style="margin-top:8px" class="flex">
          <button id="copyRef" class="btn-ghost" type="button">Copy</button>
          <button id="shareRef" class="btn-ghost" type="button">Share</button>
        </div>
        <div class="muted">Earn â‚¦1000 when your friend completes their first paid trade.</div>
      </div>

      <div class="card">
        <div class="muted">Processing time</div>
        <div id="procTimes" class="flex"></div>
        <div class="muted">Times set by admin per category.</div>
      </div>
    </div>

    <!-- Rates -->
    <div class="card">
      <div class="header"><h3 style="margin:0">Todayâ€™s Rates</h3></div>
      <div class="row row-3" style="margin-top:8px">
        <div><div class="muted">USD â†’ NGN</div><div id="rateUsd" class="money">â€”</div></div>
        <div><div class="muted">Gift cards (base)</div><div id="rateGiftBase" class="money">â€”</div></div>
        <div><div class="muted">Crypto</div><div id="rateCrypto" class="money">Uses USDâ†’NGN</div></div>
      </div>

      <div class="divider" style="margin:10px 0; height:1px; background:var(--border)"></div>

      <div class="row row-2">
        <div>
          <h4 style="margin:0 0 8px">Gift card rates</h4>
          <div id="giftRates" class="row"></div>
        </div>
        <div>
          <h4 style="margin:0 0 8px">Online wallet rates</h4>
          <div id="walletRates" class="row"></div>
        </div>
      </div>
    </div>

    <!-- Quick trade entry (gift by default) -->
    <div class="card">
      <div class="flex" style="align-items:center;gap:10px">
        <label style="margin:0">I want to sell</label>
        <select id="quickType" style="padding:8px;border-radius:8px">
          <option value="gift">Gift Card</option>
          <option value="crypto">Crypto</option>
          <option value="wallet">Online wallet</option>
        </select>
        <div style="flex:1"></div>
        <button id="openTradeBtn" class="btn-ghost">Open trade</button>
      </div>
    </div>

  </section>

  <!-- WALLET PAGE -->
  <section id="walletView" class="card hidden">
    <h3 style="margin:0 0 8px">Crypto Wallets (Admin addresses)</h3>
    <div class="row row-2">
      <div>
        <label>Crypto</label>
        <select id="cryptoTypeView"><option value="BTC">BTC</option><option value="USDT">USDT</option></select>
      </div>
      <div>
        <label>Network (USDT)</label>
        <select id="usdtNetView"><option value="">â€”</option></select>
      </div>
    </div>

    <div style="margin-top:10px" class="row row-2">
      <div>
        <label>Send to this address</label>
        <input id="cryptoAddressView" disabled />
        <div style="margin-top:8px" class="flex">
          <button id="copyAddrView" class="btn-ghost">Copy address</button>
        </div>
      </div>
      <div>
        <label>QR</label>
        <div id="qrBoxView" class="qr center" style="padding:14px;background:#fff;border-radius:8px"></div>
      </div>
    </div>
  </section>

  <!-- HISTORY PAGE -->
  <section id="historyView" class="card hidden">
    <h3 style="margin:0 0 8px">History</h3>
    <div id="history" class="row"></div>
  </section>

  <!-- PROFILE PAGE -->
  <section id="profileView" class="card hidden">
    <h3 style="margin:0 0 8px">Profile</h3>
    <div style="margin-top:8px">
      <label>Full name</label>
      <input id="pName" disabled />
    </div>
    <div style="margin-top:8px">
      <label>Username</label>
      <input id="pUsername" disabled />
    </div>
    <div style="margin-top:8px">
      <label>Email</label>
      <input id="pEmail" disabled />
    </div>
    <div style="margin-top:8px" class="flex">
      <button id="editProfileBtn" class="btn">Edit</button>
      <button id="changePwdBtn" class="btn-ghost">Change password</button>
    </div>
  </section>

  <!-- PROFILE EDIT modal area (simple inline) -->
  <section id="profileEdit" class="card hidden">
    <h4 style="margin:0 0 8px">Edit profile</h4>
    <div>
      <label>Full name</label>
      <input id="eName"/>
    </div>
    <div style="margin-top:8px">
      <label>Username</label>
      <input id="eUname"/>
    </div>
    <div style="margin-top:8px" class="flex">
      <button id="saveEditBtn" class="btn">Save</button>
      <button id="cancelEditBtn" class="btn-ghost">Cancel</button>
      <span id="editMsg" class="muted"></span>
    </div>
  </section>

</main>

<!-- Firebase + App -->
<script type="module">
/* =========================
   Firebase initialization
   ========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  sendPasswordResetEmail, signOut, updateProfile
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* ==== YOUR CONFIG (exactly as provided) ==== */
const firebaseConfig = {
  apiKey: "AIzaSyD-BIOpzkQBtpW1LQk7Rf3c-ZvyIbvEc7c",
  authDomain: "toolspay-54167.firebaseapp.com",
  projectId: "toolspay-54167",
  storageBucket: "toolspay-54167.firebasestorage.app",
  messagingSenderId: "71318117342",
  appId: "1:71318117342:web:1952711453e19e19281b4f"
};
/* ========================================== */

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ----------------- Small helpers ----------------- */
const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
const currency = n => 'â‚¦' + (Number(n||0)).toLocaleString();

/* UI refs */
const splash = $('splash');
const authView = $('authView');
const authEmail = $('authEmail');
const authPass = $('authPass');
const authPass2 = $('authPass2');
const nameInp = $('nameInp');
const unameInp = $('unameInp');
const signUpBtn = $('signUpBtn');
const signInBtn = $('signInBtn');
const forgotBtn = $('forgotBtn');
const authMsg = $('authMsg');
const authError = $('authError');

const profileSetup = $('profileSetup');
const psName = $('psName');
const psUname = $('psUname');
const saveProfileBtn = $('saveProfileBtn');
const skipProfileBtn = $('skipProfileBtn');
const psMsg = $('psMsg');

const dashView = $('dashView');
const walletView = $('walletView');
const historyView = $('historyView');
const profileView = $('profileView');
const profileEdit = $('profileEdit');

/* Nav */
const navDash = $('navDash'), navProfile = $('navProfile'), navHistory = $('navHistory'), navWallet = $('navWallet');

/* Dashboard pieces */
const balNgn = $('balNgn');
const refLinkEl = $('refLink');
const copyRef = $('copyRef');
const shareRef = $('shareRef');
const procTimes = $('procTimes');
const giftRatesBox = $('giftRates');
const walletRatesBox = $('walletRates');
const rateUsd = $('rateUsd'), rateGiftBase = $('rateGiftBase'), rateCrypto = $('rateCrypto');

/* Quick trade */
const quickType = $('quickType'), openTradeBtn = $('openTradeBtn');

/* Wallet view */
const cryptoTypeView = $('cryptoTypeView'), usdtNetView = $('usdtNetView'), cryptoAddressView = $('cryptoAddressView'), qrBoxView = $('qrBoxView'), copyAddrView = $('copyAddrView');

/* History */
const historyBox = $('history');

/* Profile */
const pName = $('pName'), pUsername = $('pUsername'), pEmail = $('pEmail'), editProfileBtn = $('editProfileBtn'), changePwdBtn = $('changePwdBtn');
const eName = $('eName'), eUname = $('eUname'), saveEditBtn = $('saveEditBtn'), cancelEditBtn = $('cancelEditBtn'), editMsg = $('editMsg');

/* Buttons */
$('modeBtn').addEventListener('click', ()=>{
  const cs = document.documentElement.style.colorScheme;
  if(cs === 'dark') document.documentElement.style.colorScheme = 'light';
  else document.documentElement.style.colorScheme = 'dark';
});

/* Chat open */
function openTawk(){ try{ window.Tawk_API?.maximize(); }catch(e){} }
$('openChatBtn').onclick = openTawk;

/* Logout */
$('logoutBtn').onclick = ()=> signOut(auth);

/* Routing (very small hash routes) */
function setActiveNav(route){
  [navDash,navProfile,navHistory,navWallet].forEach(el=>el.classList.remove('active'));
  if(route.startsWith('/profile')) navProfile.classList.add('active');
  else if(route.startsWith('/history')) navHistory.classList.add('active');
  else if(route.startsWith('/wallet')) navWallet.classList.add('active');
  else navDash.classList.add('active');
}
function showPage(route){
  // hide everything
  [dashView, walletView, historyView, profileView, profileEdit, profileSetup].forEach(s=>s.classList.add('hidden'));
  if(route.startsWith('/profile')) profileView.classList.remove('hidden');
  else if(route.startsWith('/history')) historyView.classList.remove('hidden');
  else if(route.startsWith('/wallet')) walletView.classList.remove('hidden');
  else dashView.classList.remove('hidden');
  setActiveNav(route);
}
function routeWatcher(){
  const hash = location.hash || '#/dashboard';
  const route = hash.slice(1);
  showPage(route);
}
window.addEventListener('hashchange', routeWatcher);
navDash.onclick = ()=>{ location.hash = '#/dashboard'; };
navProfile.onclick = ()=>{ location.hash = '#/profile'; };
navHistory.onclick = ()=>{ location.hash = '#/history'; };
navWallet.onclick = ()=>{ location.hash = '#/wallet'; };
routeWatcher();

/* ------------------ Splash helpers ------------------ */
function hideSplashFast(){
  splash.classList.add('hidden');
  setTimeout(()=>{ if(splash.parentNode) splash.style.display='none'; },350);
}
/* hard cap: if auth not responded in 2.5s show auth quickly */
let authResponded = false;
setTimeout(()=>{
  if(!authResponded){
    authView.classList.remove('hidden');
    hideSplashFast();
  }
}, 2500);

/* ------------------ State ------------------ */
let currentUser = null;
let usdToNgn = 0;
let giftRates = {};
let walletRateMap = {};
let btcAddress = '';
let usdtNetworks = [];
let procTimeMap = {};

/* ------------------ Utilities ------------------ */
function isEmailValid(email){
  return typeof email === 'string' && /\S+@\S+\.\S+/.test(email);
}
function showError(msg){
  authError.textContent = msg || '';
}
function clearAuthMsg(){ authMsg.textContent=''; authError.textContent=''; }

/* ------------------ QR renderer ------------------ */
function renderQR(target, text){
  target.innerHTML = '';
  if(!text){ target.textContent = 'â€”'; return; }
  const img = new Image();
  img.alt = 'QR';
  img.style.maxWidth = '160px';
  img.src = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(text)}`;
  img.onerror = ()=>{ target.textContent = text; };
  target.appendChild(img);
}

/* ------------------ Firestore public data loader ------------------ */
async function loadPublicData(){
  try{
    const r = await getDoc(doc(db,'rates','default'));
    if(r.exists()){
      const d = r.data();
      usdToNgn = Number(d.usdToNgn || 0);
      rateUsd.textContent = currency(usdToNgn);
      rateGiftBase.textContent = currency(Number(d.giftcardBase||0)) + ' / $';
    } else { rateUsd.textContent='â€”'; rateGiftBase.textContent='â€”'; }
  }catch(e){ console.warn('rates load', e); }

  try{
    const w = await getDoc(doc(db,'wallets','default'));
    if(w.exists()){
      const d = w.data();
      btcAddress = d?.btc?.address || '';
      usdtNetworks = d?.usdt?.networks || [];
      usdtNetView.innerHTML = '<option value="">â€”</option>' + usdtNetworks.map(n=>`<option value="${n.network}">${n.network}</option>`).join('');
    }
  }catch(e){ console.warn('wallets load', e); }

  try{
    const a = await getDoc(doc(db,'announcements','default'));
    procTimes.innerHTML = '';
    if(a.exists()){
      (a.data().items||[]).forEach(i=>{
        const s = document.createElement('span'); s.className='chip'; s.textContent = i; procTimes.appendChild(s);
      });
    }
  }catch(e){}

  try{
    const gr = await getDoc(doc(db,'giftcardRates','default'));
    giftRates = gr.exists() ? (gr.data().brands||{}) : {};
  }catch(e){ giftRates={}; }

  try{
    const wr = await getDoc(doc(db,'walletRates','default'));
    walletRateMap = wr.exists() ? (wr.data().types||{}) : {};
  }catch(e){ walletRateMap={}; }

  renderRateBoxes();
}

/* render rates */
function renderRateBoxes(){
  giftRatesBox.innerHTML = '';
  Object.entries(giftRates).forEach(([brand,obj])=>{
    const div = document.createElement('div'); div.className='chip';
    const countries = obj?.countries||{};
    const pieces = Object.entries(countries).slice(0,5).map(([cc,rate])=>`${cc}: â‚¦${rate}/$`);
    div.textContent = `${brand} â€” ${pieces.join(' â€¢ ')}${Object.keys(countries).length>5?' â€¦':''}`;
    giftRatesBox.appendChild(div);
  });
  if(!Object.keys(giftRates).length) giftRatesBox.textContent = 'No gift rates yet.';

  walletRatesBox.innerHTML = '';
  Object.entries(walletRateMap).forEach(([type,obj])=>{
    const div = document.createElement('div'); div.className='chip';
    const countries = obj?.countries||{};
    const pieces = Object.entries(countries).slice(0,5).map(([cc,rate])=>`${cc}: â‚¦${rate}/$`);
    div.textContent = `${type} â€” ${pieces.join(' â€¢ ')}${Object.keys(countries).length>5?' â€¦':''}`;
    walletRatesBox.appendChild(div);
  });
  if(!Object.keys(walletRateMap).length) walletRatesBox.textContent = 'No wallet rates yet.';
}

/* ------------------ Signup / Signin flows ------------------ */
signUpBtn.onclick = async ()=>{
  clearAuthMsg();
  const name = (nameInp.value||'').trim();
  const uname = (unameInp.value||'').trim();
  const email = (authEmail.value||'').trim();
  const pass = authPass.value || '';
  const pass2 = authPass2.value || '';
  if(!name || !uname || !email || !pass || !pass2){ showError('Please fill all fields.'); return; }
  if(pass !== pass2){ showError('Passwords do not match.'); return; }
  if(!isEmailValid(email)){ showError('Please enter a valid email.'); return; }
  if(uname.includes(' ')){ showError('Username cannot contain spaces.'); return; }
  authMsg.textContent = 'Creating account...';
  try{
    // create account
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    // create user doc with profileIncomplete flag
    await setDoc(doc(db,'users',cred.user.uid), {
      email: cred.user.email,
      createdAt: serverTimestamp(),
      balance: 0,
      bank: { bankName:'', acctName:'', acctNo:'' },
      displayName: name,
      username: uname,
      profileComplete: true // we already collected name & username at signup
    }, { merge:true });
    authMsg.textContent = 'Account created. Signed in.';
    // auth state change will carry on
  }catch(e){
    console.error(e);
    showError(e?.message || e?.code || 'Signup error');
    authMsg.textContent = '';
  }
};

signInBtn.onclick = async ()=>{
  clearAuthMsg();
  const email = (authEmail.value||'').trim();
  const pass = authPass.value || '';
  if(!email || !pass){ showError('Enter email and password.'); return; }
  authMsg.textContent = 'Signing in...';
  try{
    await signInWithEmailAndPassword(auth, email, pass);
    authMsg.textContent = '';
  }catch(e){
    console.error(e);
    showError(e?.message || e?.code || 'Sign in failed');
    authMsg.textContent = '';
  }
};

forgotBtn.onclick = async ()=>{
  clearAuthMsg();
  const email = (authEmail.value||'').trim();
  if(!isEmailValid(email)){ showError('Enter a valid email to reset.'); return; }
  try{
    await sendPasswordResetEmail(auth, email);
    authMsg.textContent = 'Reset email sent.';
  }catch(e){
    showError(e?.message || e?.code || 'Reset failed');
  }
};

/* ------------------ Profile setup after signup (if needed) ------------------ */
skipProfileBtn.onclick = async ()=>{
  psMsg.textContent = 'Skipped.';
  profileSetup.classList.add('hidden');
  authMsg.textContent = 'You can edit profile later in Profile page.';
};
saveProfileBtn.onclick = async ()=>{
  const name = (psName.value||'').trim();
  const uname = (psUname.value||'').trim();
  if(!name || !uname){ psMsg.textContent = 'Fill name and username.'; return; }
  psMsg.textContent = 'Saving...';
  try{
    await updateDoc(doc(db,'users', currentUser.uid), { displayName: name, username: uname, profileComplete:true });
    psMsg.textContent = 'Saved âœ“';
    profileSetup.classList.add('hidden');
    authMsg.textContent = '';
    routeWatcher();
  }catch(e){
    psMsg.textContent = e?.message || 'Save failed';
  }
};

/* ------------------ Watch user data / history / withdrawals ------------------ */
function watchUserData(uid){
  // user doc
  onSnapshot(doc(db,'users',uid),(snap)=>{
    const d = snap.data()||{};
    balNgn.textContent = currency(Number(d.balance||0));
    refLinkEl.textContent = `${location.origin}${location.pathname}?ref=${uid}`;
    pName.value = d.displayName || '';
    pUsername.value = d.username || '';
    pEmail.value = d.email || (auth.currentUser?.email || '');
  });

  // trades history
  const q1 = query(collection(db,'trades'), where('uid','==', uid), orderBy('createdAt','desc'));
  onSnapshot(q1, qs=>{
    historyBox.innerHTML = '';
    qs.forEach(docu=>{
      const t = docu.data();
      const item = document.createElement('div'); item.className='card';
      item.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px"><div><strong>${(t.type||'').toUpperCase()}</strong><div class="muted">${t.brand||t.walletType||''} ${t.country||''}</div></div><div><span class="chip">${t.status||'pending'}</span></div></div>
        <div style="margin-top:8px" class="muted">${JSON.stringify({ amountUsd:t.amountUsd, amountCrypto:t.amountCrypto, est: t.estimatedNgn })}</div>`;
      historyBox.appendChild(item);
    });
  });

  // withdrawals
  const q2 = query(collection(db,'withdrawals'), where('uid','==', uid), orderBy('createdAt','desc'));
  onSnapshot(q2, qs=>{
    if(!qs.empty){
      const title = document.createElement('div'); title.innerHTML = '<div class="divider" style="height:1px;background:var(--border);margin:8px 0"></div><h4>Your withdrawals</h4>';
      historyBox.appendChild(title);
      qs.forEach(docu=>{
        const w = docu.data();
        const item = document.createElement('div'); item.className='card';
        item.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>WITHDRAW</strong></div><div class="chip">${w.status||'pending'}</div></div><div style="margin-top:8px">${currency(w.amount)}</div>`;
        historyBox.appendChild(item);
      });
    }
  });
}

/* ------------------ Crypto address view logic ------------------ */
function refreshWalletView(){
  if(cryptoTypeView.value === 'BTC'){
    cryptoAddressView.value = btcAddress || '';
    renderQR(qrBoxView, btcAddress || '');
    usdtNetView.value = '';
    usdtNetView.disabled = true;
  } else {
    usdtNetView.disabled = false;
    const sel = usdtNetworks.find(n=>n.network===usdtNetView.value) || usdtNetworks[0];
    const addr = sel?.address || '';
    cryptoAddressView.value = addr;
    renderQR(qrBoxView, addr);
  }
}
cryptoTypeView.onchange = refreshWalletView;
usdtNetView.onchange = refreshWalletView;
copyAddrView.onclick = async ()=> {
  if(!cryptoAddressView.value) return;
  try{ await navigator.clipboard.writeText(cryptoAddressView.value); copyAddrView.textContent='Copied âœ“'; setTimeout(()=>copyAddrView.textContent='Copy address',900);}catch(e){}
};

/* copy/ref share */
copyRef.onclick = async ()=>{ try{ await navigator.clipboard.writeText(refLinkEl.textContent); copyRef.textContent='Copied âœ“'; setTimeout(()=>copyRef.textContent='Copy',900);}catch(e){} };
shareRef.onclick = async ()=>{ try{ if(navigator.share) await navigator.share({ title:'Toolspay', text:'Trade on Toolspay', url:refLinkEl.textContent }); else await navigator.clipboard.writeText(refLinkEl.textContent); }catch(e){} };

/* ------------------ Auth state watcher ------------------ */
onAuthStateChanged(auth, async (user)=>{
  authResponded = true;
  if(!user){
    // show auth
    currentUser = null;
    authView.classList.remove('hidden');
    dashView.classList.add('hidden');
    profileSetup.classList.add('hidden');
    profileView.classList.add('hidden');
    hideSplashFast();
    return;
  }
  currentUser = user;
  // Ensure user doc exists and check profileComplete
  try{
    const uref = doc(db,'users', user.uid);
    const udoc = await getDoc(uref);
    if(!udoc.exists()){
      await setDoc(uref, { email: user.email, createdAt: serverTimestamp(), balance: 0, bank:{}, profileComplete:false }, { merge:true });
    }
    const udata = (udoc.exists() ? udoc.data() : {});
    // load controls
    await loadPublicData();
    watchUserData(user.uid);
    // show proper view
    authView.classList.add('hidden');
    // if profile incomplete -> show profile setup
    if(!udata.profileComplete){
      profileSetup.classList.remove('hidden');
      psName.value = udata.displayName || nameInp.value || '';
      psUname.value = udata.username || unameInp.value || '';
      hideSplashFast();
      return;
    }
    // else show dashboard
    profileSetup.classList.add('hidden');
    profileView.classList.remove('hidden'); // but route will show dashboard
    routeWatcher();
    hideSplashFast();
    // populate wallet view data
    refreshWalletView();
  }catch(e){
    console.error('auth onChange', e);
    // fallback to auth
    authView.classList.remove('hidden');
    hideSplashFast();
  }
});

/* ------------------ Profile edit flows ------------------ */
editProfileBtn.onclick = ()=>{
  profileEdit.classList.remove('hidden');
  profileView.classList.add('hidden');
  eName.value = pName.value; eUname.value = pUsername.value;
};
cancelEditBtn.onclick = ()=>{
  profileEdit.classList.add('hidden');
  profileView.classList.remove('hidden');
};
saveEditBtn.onclick = async ()=>{
  editMsg.textContent = 'Saving...';
  try{
    await updateDoc(doc(db,'users', currentUser.uid), { displayName: eName.value.trim(), username: eUname.value.trim() });
    editMsg.textContent = 'Saved âœ“';
    setTimeout(()=>{ editMsg.textContent=''; profileEdit.classList.add('hidden'); profileView.classList.remove('hidden'); },900);
  }catch(e){ editMsg.textContent = e?.message || 'Save failed'; }
};

/* ------------------ small extras ------------------ */
openTradeBtn.onclick = ()=>{
  const t = quickType.value;
  if(t === 'gift') location.hash = '#/dashboard'; // user will see rates, can click Sell
  else if(t === 'crypto') location.hash = '#/wallet';
  else location.hash = '#/wallet';
};

/* Ensure nav shows page on load */
routeWatcher();

</script>

</body>
  </html>
