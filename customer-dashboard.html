<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Toolspay — Dashboard</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<header class="topbar">
  <div class="brand">Toolspay</div>
  <div class="spacer"></div>
  <button id="logoutBtn" class="btn-ghost">Logout</button>
</header>

<main class="container">
  <section class="row">
    <div class="card">
      <h2>Announcements</h2>
      <ul id="annList" class="bullets"></ul>
    </div>

    <div class="card">
      <h2>Your balance</h2>
      <div><b>Available (₦):</b> <span id="balNgn">0</span></div>
      <h3 style="margin-top:12px;">Withdraw</h3>
      <div class="row">
        <input id="wBank" placeholder="Bank name"/>
        <input id="wAccName" placeholder="Account name"/>
        <input id="wAccNo" placeholder="Account number"/>
      </div>
      <div class="row">
        <input id="wAmount" type="number" placeholder="Amount ₦"/>
        <button id="reqWithdraw" class="btn-primary">Request Withdraw</button>
      </div>
      <div id="withMsg" class="muted"></div>
      <h4 style="margin-top:12px;">History</h4>
      <ul id="balHistory" class="bullets small"></ul>
    </div>
  </section>

  <section class="card">
    <h2>Rates (live)</h2>
    <div class="muted">Admin-managed per brand/country + online wallet types; preview payout appears in forms.</div>
    <div id="ratesQuick" class="chips"></div>
  </section>

  <section class="row">
    <!-- Gift cards -->
    <div class="card">
      <h2>Sell Gift Card</h2>
      <div class="row">
        <select id="gcBrand">
          <option>Amazon</option><option>iTunes</option><option>Steam</option><option>Google Play</option>
          <option>Walmart</option><option>Razer Gold</option><option>Vanilla Visa</option><option>Amex</option>
        </select>
        <select id="gcCountry">
          <option>USA</option><option>UK</option><option>Canada</option><option>Australia</option><option>EU</option><option>Switzerland</option>
        </select>
        <input id="gcFace" type="number" placeholder="Face value (USD)"/>
      </div>
      <div class="row">
        <input id="gcNote" placeholder="Note (optional)"/>
      </div>
      <div class="muted">Upload up to 3 images (card front/back/receipt)</div>
      <div class="row">
        <input id="gcImg1" type="file" accept="image/*"/>
        <input id="gcImg2" type="file" accept="image/*"/>
        <input id="gcImg3" type="file" accept="image/*"/>
      </div>
      <div class="calc">
        Expected payout (₦): <b id="gcPayout">0</b>
        <button id="gcCalc" class="btn-ghost">Calculate</button>
      </div>
      <button id="gcSubmit" class="btn-primary">Submit Gift Card</button>
      <div id="gcMsg" class="muted"></div>
    </div>

    <!-- Crypto -->
    <div class="card">
      <h2>Sell Crypto (BTC/USDT)</h2>
      <div class="row">
        <select id="cType"><option>BTC</option><option>USDT</option></select>
        <select id="cNetwork"><option value="">(choose for USDT)</option></select>
        <input id="cAmountUsd" type="number" placeholder="Amount (USD est)"/>
      </div>
      <div class="calc">
        Expected payout (₦): <b id="cPayout">0</b>
        <button id="cCalc" class="btn-ghost">Calculate</button>
      </div>
      <div id="walletBox" class="muted"></div>
      <div id="qrBox" class="qr"></div>
      <button id="cSubmit" class="btn-primary">I sent the crypto</button>
      <div id="cMsg" class="muted"></div>
    </div>
  </section>

  <section class="row">
    <!-- Online wallet -->
    <div class="card">
      <h2>Sell Online Wallet Balance</h2>
      <div class="row">
        <select id="owType"><option>Chime</option><option>Zelle</option><option>Venmo</option><option>PayPal</option></select>
        <select id="owCountry">
          <option>USA</option><option>UK</option><option>Canada</option><option>Australia</option><option>EU</option><option>Switzerland</option>
        </select>
        <input id="owUsd" type="number" placeholder="Amount (USD)"/>
      </div>
      <div class="calc">
        Expected payout (₦): <b id="owPayout">0</b>
        <button id="owCalc" class="btn-ghost">Calculate</button>
      </div>
      <p class="muted">To trade online wallets, <b>use live chat</b> to request the exact tag from admin, then send and upload proof there.</p>
      <button id="openChat" class="btn-primary">Chat admin for tag</button>
    </div>

    <!-- My trades -->
    <div class="card">
      <h2>My Trades</h2>
      <ul id="myTrades" class="bullets small"></ul>
    </div>
  </section>
</main>

<script type="module">
  import {
    auth, db, storage, onAuthStateChanged, signOut,
    doc, getDoc, setDoc, addDoc, collection, updateDoc, serverTimestamp,
    ref, uploadBytes, getDownloadURL,
    calcGiftPayout, calcWalletPayout
  } from './firebase-auth.js';

  const logoutBtn = document.getElementById('logoutBtn');
  logoutBtn.onclick = async ()=>{ await signOut(auth); location.href='login.html'; };

  let me;

  onAuthStateChanged(auth, async (user)=>{
    if (!user) { location.href='login.html'; return; }
    if (!user.emailVerified){ alert('Please verify your email first.'); location.href='login.html'; return; }
    me = user;
    await ensureUserDoc();
    loadAnnouncements();
    loadBalance();
    loadRatesQuick();
    loadWalletsForCrypto();
    loadMyTrades();
  });

  async function ensureUserDoc(){
    const uref = doc(db, 'users', auth.currentUser.uid);
    const s = await getDoc(uref);
    if (!s.exists()) {
      await setDoc(uref, {
        email: auth.currentUser.email, name: auth.currentUser.displayName || '', balanceNgn:0,
        bank:{ bankName:'', accountName:'', accountNumber:'' }, createdAt: Date.now()
      }, { merge:true });
    }
  }

  // Announcements
  async function loadAnnouncements(){
    const a = await getDoc(doc(db, 'announcements', 'default'));
    const list = document.getElementById('annList'); list.innerHTML='';
    if (a.exists()){
      const arr = Array.isArray(a.data().items)?a.data().items:[];
      arr.forEach(t=>{
        const li=document.createElement('li'); li.textContent=t; list.appendChild(li);
      });
    }
  }

  // Balance & withdraw
  async function loadBalance(){
    const s = await getDoc(doc(db, 'users', auth.currentUser.uid));
    const b = Number(s.data()?.balanceNgn||0);
    document.getElementById('balNgn').textContent = b.toLocaleString();
    // history stream
    const ul = document.getElementById('balHistory'); ul.innerHTML='';
    const hs = await (await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"))
      .getDocs(collection(db, "users", auth.currentUser.uid, "balanceHistory"));
    hs.forEach(h=>{
      const d=h.data();
      const li=document.createElement('li');
      li.textContent=`${d.change>0?'+':''}${d.change} — ${d.reason||''}`;
      ul.appendChild(li);
    });
  }

  document.getElementById('reqWithdraw').onclick = async ()=>{
    const bankName  = document.getElementById('wBank').value.trim();
    const accName   = document.getElementById('wAccName').value.trim();
    const accNo     = document.getElementById('wAccNo').value.trim();
    const amount    = Number(document.getElementById('wAmount').value || 0);
    const msg = document.getElementById('withMsg');
    if (!bankName || !accName || !accNo || amount<=0){ msg.textContent='Fill all fields.'; return; }

    await setDoc(doc(db,'users',auth.currentUser.uid),{ bank:{ bankName, accountName:accName, accountNumber:accNo }},{merge:true});
    await addDoc(collection(db,'withdrawRequests'),{
      uid: auth.currentUser.uid, email: auth.currentUser.email,
      bank:{ bankName, accountName:accName, accountNumber:accNo },
      amountNgn: amount, status:'Pending', createdAt: serverTimestamp()
    });
    msg.textContent='Withdraw request submitted.';
  };

  // Rates quick board
  async function loadRatesQuick(){
    const board = document.getElementById('ratesQuick'); board.innerHTML='';
    // gift cards (few samples)
    const brands = ['Amazon','iTunes','Steam','Google Play','Walmart','Razer Gold','Vanilla Visa','Amex'];
    const countries = ['USA','UK','Canada','Australia','EU','Switzerland'];
    for (const b of brands){
      for (const c of countries){
        const id = `${b}__${c}`;
        const s = await getDoc(doc(db,'giftCardRates', id));
        if (s.exists()){
          const chip=document.createElement('span');
          chip.className='chip';
          chip.textContent=`${b} (${c}) ₦${s.data().rateNgnPerUsd}/$`;
          board.appendChild(chip);
        }
      }
    }
    // online wallets
    const ow = ['Chime','Zelle','Venmo','PayPal'];
    for (const t of ow){
      for (const c of countries){
        const id = `${t}__${c}`;
        const s = await getDoc(doc(db,'walletRates', id));
        if (s.exists()){
          const chip=document.createElement('span');
          chip.className='chip';
          chip.textContent=`${t} (${c}) ₦${s.data().rateNgnPerUsd}/$`;
          board.appendChild(chip);
        }
      }
    }
  }

  // Gift card submit
  async function uploadImg(file){
    if (!file) return null;
    const path=`trades/${auth.currentUser.uid}/${Date.now()}_${file.name}`;
    const r = ref(storage, path);
    await uploadBytes(r, file);
    return await getDownloadURL(r);
  }

  document.getElementById('gcCalc').onclick = async ()=>{
    const payout = await calcGiftPayout(
      document.getElementById('gcBrand').value,
      document.getElementById('gcCountry').value,
      Number(document.getElementById('gcFace').value||0)
    );
    document.getElementById('gcPayout').textContent = payout.toLocaleString();
  };

  document.getElementById('gcSubmit').onclick = async ()=>{
    const brand=document.getElementById('gcBrand').value;
    const country=document.getElementById('gcCountry').value;
    const face=Number(document.getElementById('gcFace').value||0);
    const note=document.getElementById('gcNote').value.trim();
    const gcMsg=document.getElementById('gcMsg');
    if (!brand||!country||!face){ gcMsg.textContent='Fill brand, country and face value.'; return; }
    gcMsg.textContent='Uploading...';
    const img1=await uploadImg(document.getElementById('gcImg1').files[0]);
    const img2=await uploadImg(document.getElementById('gcImg2').files[0]);
    const img3=await uploadImg(document.getElementById('gcImg3').files[0]);

    const refDoc = await addDoc(collection(db,'trades'),{
      uid: auth.currentUser.uid, email: auth.currentUser.email, type:'giftcard',
      brand, country, faceUsd: face, note,
      images:[img1,img2,img3].filter(Boolean),
      status:'Pending', createdAt: serverTimestamp()
    });
    gcMsg.textContent='Submitted. We will review and pay to your bank.';
  };

  // Crypto
  async function loadWalletsForCrypto(){
    const w = await getDoc(doc(db,'wallets','default'));
    const box = document.getElementById('walletBox'); box.innerHTML='';
    const qrBox = document.getElementById('qrBox'); qrBox.innerHTML='';
    const cNet = document.getElementById('cNetwork'); cNet.innerHTML='<option value="">(choose for USDT)</option>';
    if (w.exists()){
      const d=w.data();
      // BTC
      if (d?.btc?.address){
        const div = document.createElement('div');
        div.innerHTML = `<b>BTC Address:</b> ${d.btc.address}`;
        box.appendChild(div);
      }
      // USDT networks
      const nets = d?.usdt?.networks||[];
      nets.forEach(n=>{
        const opt=document.createElement('option');
        opt.value = n.network;
        opt.textContent = n.network;
        cNet.appendChild(opt);
      });
    }
  }

  document.getElementById('cCalc').onclick = async ()=>{
    const usd = Number(document.getElementById('cAmountUsd').value||0);
    // We use generic usd->ngn rate if set (optional enhancement)
    const r = await getDoc(doc(db,'rates','default'));
    const usdToNgn = r.exists()? Number(r.data()?.usdToNgn||0):0;
    document.getElementById('cPayout').textContent = Math.round(usdToNgn*usd).toLocaleString();
  };

  document.getElementById('cSubmit').onclick = async ()=>{
    const type=document.getElementById('cType').value;
    const net=document.getElementById('cNetwork').value;
    const amountUsd=Number(document.getElementById('cAmountUsd').value||0);
    const cMsg=document.getElementById('cMsg');
    if (type==='USDT' && !net){ cMsg.textContent='Choose USDT network.'; return; }
    if (amountUsd<=0){ cMsg.textContent='Enter amount.'; return; }
    await addDoc(collection(db,'trades'),{
      uid: auth.currentUser.uid, email: auth.currentUser.email, type:'crypto',
      cryptoType:type, network: net||null, amountUsd,
      status:'Waiting Confirm', createdAt: serverTimestamp()
    });
    cMsg.textContent='Submitted. We’ll confirm on chain and pay to your bank.';
  };

  // Online wallet (live chat only)
  document.getElementById('owCalc').onclick = async ()=>{
    const payout = await calcWalletPayout(
      document.getElementById('owType').value,
      document.getElementById('owCountry').value,
      Number(document.getElementById('owUsd').value||0)
    );
    document.getElementById('owPayout').textContent = payout.toLocaleString();
  };
  document.getElementById('openChat').onclick = ()=>{ if (window.Tawk_API) window.Tawk_API.maximize(); };

  // My trades
  async function loadMyTrades(){
    const ul=document.getElementById('myTrades'); ul.innerHTML='';
    const all = await getDocs(collection(db,'trades'));
    all.forEach(t=>{
      const d=t.data(); if (d.uid!==auth.currentUser.uid) return;
      const li=document.createElement('li');
      li.textContent = `[${d.type}] ${d.brand||d.cryptoType||''} — ${d.status||''}`;
      ul.appendChild(li);
    });
  }
</script>

<!-- Tawk chat (your widget) -->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;s1.src='https://embed.tawk.to/689c8ac8fcd547192dde2522/1j2hns8ng';
s1.charset='UTF-8';s1.setAttribute('crossorigin','*');s0.parentNode.insertBefore(s1,s0);
})();
</script>
</body>
</html>
