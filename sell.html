<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sell Gift Card - Toolspay</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Sell Your Gift Card</h1>

  <form id="giftCardForm">
    <label for="cardName">Gift Card Name:</label>
    <input type="text" id="cardName" name="cardName" required />

    <label for="usdAmount">USD Value:</label>
    <input type="number" id="usdAmount" name="usdAmount" required />

    <label for="logoFile">Gift Card Logo:</label>
    <input type="file" id="logoFile" name="logoFile" accept="image/*" required />

    <label for="uploadFile">Gift Card Proof Image:</label>
    <input type="file" id="uploadFile" name="uploadFile" accept="image/*" required />

    <button type="submit">Submit</button>
  </form>

  <script type="module">
    import { auth, onAuthStateChanged, createTradeRequest, saveGiftcard } from "./firebase-auth.js";

    const giftCardForm = document.getElementById("giftCardForm");
    let currentUser = null;

    // Check login status
    onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
      }
    });

    giftCardForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const cardName = document.getElementById("cardName").value;
      const usdAmount = document.getElementById("usdAmount").value;
      const logoFile = document.getElementById("logoFile").files[0];
      const uploadFile = document.getElementById("uploadFile").files[0];

      if (!currentUser) {
        alert("You must be logged in to sell a gift card.");
        return;
      }

      try {
        // Save the gift card brand/logo in Firestore
        await saveGiftcard(cardName.toLowerCase().replace(/\s+/g, "-"), {
          name: cardName,
          logoUrl: ""
        }, logoFile);

        // Create the trade request for selling the card
        await createTradeRequest({
          uid: currentUser.uid,
          email: currentUser.email,
          name: currentUser.displayName || "",
          service: "giftcard",
          cardId: cardName,
          usd: usdAmount,
          uploadFile: uploadFile
        });

        // Redirect to dashboard with success message
        window.location.href = "dashboard.html?success=giftcard";
      } catch (error) {
        alert("Error submitting gift card: " + error.message);
      }
    });
  </script>
</body>
</html>
