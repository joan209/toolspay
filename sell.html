<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sell Gift Card - Toolspay</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Sell Your Gift Card</h1>

  <form id="giftCardForm">
    <label for="cardName">Gift Card Name:</label>
    <input type="text" id="cardName" name="cardName" required />

    <label for="usdAmount">USD Value:</label>
    <input type="number" id="usdAmount" name="usdAmount" required />

    <label for="logoFile">Gift Card Logo:</label>
    <input type="file" id="logoFile" name="logoFile" accept="image/*" required />

    <label for="uploadFile">Gift Card Proof Image:</label>
    <input type="file" id="uploadFile" name="uploadFile" accept="image/*" required />

    <button type="submit">Submit</button>
  </form>

  <script type="module"// Firestore refs
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const auth = getAuth();
const db = getFirestore();

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Please log in to sell a gift card.");
    window.location.href = "login.html";
    return;
  }

  // Fetch user's payment info
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);
  let paymentDetails = {};
  if (userSnap.exists()) {
    paymentDetails = userSnap.data().paymentMethods || {};
  }

  // Handle sell form submission
  document.getElementById("sellForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const cardType = document.getElementById("cardType").value;
    const amount = document.getElementById("amount").value;
    const proofFile = document.getElementById("proof").files[0];

    if (!proofFile) {
      alert("Please upload proof of your card.");
      return;
    }

    try {
      // Store trade in Firestore
      await addDoc(collection(db, "trades"), {
        uid: user.uid,
        cardType: cardType,
        amount: amount,
        proofName: proofFile.name,
        paymentDetails: paymentDetails,
        status: "Pending",
        createdAt: serverTimestamp()
      });

      alert("Gift card submitted successfully! Waiting for approval.");
      window.location.href = "dashboard.html";

    } catch (error) {
      console.error("Error submitting trade:", error);
      alert("Something went wrong. Try again.");
    }
  });
});>
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const sellForm = document.getElementById("sellForm");

  let currentUser = null;
  let savedPaymentDetails = null;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;

      // Get saved payment details from Firestore
      const userDoc = await getDoc(doc(db, "users", user.uid));
      if (userDoc.exists()) {
        savedPaymentDetails = userDoc.data().paymentMethod || {};
      } else {
        alert("Please set your payment method in the dashboard before selling a gift card.");
        window.location.href = "dashboard.html";
      }
    } else {
      window.location.href = "login.html";
    }
  });

  sellForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const cardType = document.getElementById("cardType").value;
    const amount = document.getElementById("amount").value;
    const file = document.getElementById("proof").files[0];

    if (!file) {
      alert("Please upload proof of the gift card.");
      return;
    }

    // Upload proof image
    const proofRef = ref(storage, `proofs/${Date.now()}_${file.name}`);
    await uploadBytes(proofRef, file);
    const proofURL = await getDownloadURL(proofRef);

    // Save trade to Firestore with payment details
    await addDoc(collection(db, "trades"), {
      userId: currentUser.uid,
      email: currentUser.email,
      cardType: cardType,
      amount: amount,
      proofURL: proofURL,
      paymentDetails: savedPaymentDetails,
      status: "Pending",
      createdAt: serverTimestamp()
    });

    alert("Gift card submitted successfully! We will process your payment soon.");
    window.location.href = "dashboard.html";
  });
  </script>
    import { auth, onAuthStateChanged, createTradeRequest, saveGiftcard } from "./firebase-auth.js";

    const giftCardForm = document.getElementById("giftCardForm");
    let currentUser = null;

    // Check login status
    onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
      }
    });

    giftCardForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const cardName = document.getElementById("cardName").value;
      const usdAmount = document.getElementById("usdAmount").value;
      const logoFile = document.getElementById("logoFile").files[0];
      const uploadFile = document.getElementById("uploadFile").files[0];

      if (!currentUser) {
        alert("You must be logged in to sell a gift card.");
        return;
      }

      try {
        // Save the gift card brand/logo in Firestore
        await saveGiftcard(cardName.toLowerCase().replace(/\s+/g, "-"), {
          name: cardName,
          logoUrl: ""
        }, logoFile);

        // Create the trade request for selling the card
        await createTradeRequest({
          uid: currentUser.uid,
          email: currentUser.email,
          name: currentUser.displayName || "",
          service: "giftcard",
          cardId: cardName,
          usd: usdAmount,
          uploadFile: uploadFile
        });

        // Redirect to dashboard with success message
        window.location.href = "dashboard.html?success=giftcard";
      } catch (error) {
        alert("Error submitting gift card: " + error.message);
      }
    });
  </script>
</body>
</html>
